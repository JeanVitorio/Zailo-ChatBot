<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZailonSoft Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --cor-fundo-escuro: #060918;
        --cor-fundo-card: #0f1326;
        --cor-borda: #1d233f;
        --cor-destaque: #00f5ff;
        --cor-destaque-hover: #00d5e0;
        --cor-texto-principal: #e2e8f0;
        --cor-texto-secundario: #94a3b8;
        --cor-success: #22c55e;
        --cor-danger: #ef4444;
        --cor-gradiente-principal: linear-gradient(
          145deg,
          #060918 0%,
          #0c122d 100%
        );
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: var(--cor-gradiente-principal);
        color: var(--cor-texto-principal);
        overflow-x: hidden;
        min-height: 100vh;
        display: flex;
      }

      .container {
        flex-grow: 1;
        padding: 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-left: 17rem;
        width: calc(100% - 17rem);
        max-width: 1600px;
        margin: 0 auto;
        padding-left: 18rem;
      }

      .header {
        display: none;
      }

      .logo {
        font-family: "Poppins", sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--cor-destaque);
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .nav {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
      }

      .nav a {
        color: var(--cor-texto-secundario);
        text-decoration: none;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .nav a svg {
        fill: var(--cor-texto-secundario);
        width: 1.2rem;
        height: 1.2rem;
        transition: fill 0.3s ease;
      }

      .nav a:hover,
      .nav a.active {
        color: var(--cor-destaque);
        background-color: rgba(0, 245, 255, 0.1);
      }

      .nav a:hover svg,
      .nav a.active svg {
        fill: var(--cor-destaque);
      }

      .nav a.active {
        background-color: rgba(0, 245, 255, 0.2);
        font-weight: 600;
        border-left: 3px solid var(--cor-destaque);
        padding-left: 1.25rem;
      }

      .tab-content {
        display: none;
        background: var(--cor-fundo-card);
        padding: 2.5rem;
        border-radius: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        animation: fadeIn 0.6s ease-in-out;
        min-height: 85vh;
        border: 1px solid var(--cor-borda);
      }

      .tab-content.active {
        display: block;
      }

      #crm.tab-content.active {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 5rem);
        max-height: 90vh;
      }

      .tab-content h2 {
        font-family: "Poppins", sans-serif;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--cor-texto-principal);
        text-transform: uppercase;
        letter-spacing: 1px;
        flex-shrink: 0;
      }

      #dashboard {
        grid-template-columns: 1fr;
        gap: 2rem;
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
      }

      #dashboard.active {
        display: grid;
      }

      #dashboard > h2 {
        text-align: left;
        margin: 0;
        padding-bottom: 1rem;
        position: relative;
        border-bottom: 1px solid var(--cor-borda);
      }

      #dashboard > h2::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -1px;
        width: 80px;
        height: 2px;
        background-color: var(--cor-destaque);
        box-shadow: 0 0 10px var(--cor-destaque);
      }

      .dashboard-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .metric-card {
        background: linear-gradient(145deg, #10152b, #0c1021);
        padding: 1.5rem;
        border-radius: 1rem;
        border-left: 4px solid var(--cor-borda);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s ease-in-out;
      }

      .metric-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 0 25px rgba(0, 245, 255, 0.15);
        border-left-color: var(--cor-destaque);
      }

      .metric-icon {
        font-size: 2.5rem;
        color: var(--cor-destaque);
        opacity: 0.7;
      }

      .metric-content h3 {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
        color: var(--cor-texto-secundario);
      }

      .metric-content p {
        font-size: 2rem;
        font-weight: 700;
        color: var(--cor-texto-principal);
      }

      .metric-card.success {
        border-left-color: var(--cor-success);
      }

      .metric-card.danger {
        border-left-color: var(--cor-danger);
      }

      .metric-card.success .metric-icon { color: var(--cor-success); }
      .metric-card.danger .metric-icon { color: var(--cor-danger); }

      .metric-card.success .metric-content p { color: var(--cor-success); }
      .metric-card.danger .metric-content p { color: var(--cor-danger); }

      .chart-card {
        padding: 1.5rem;
        border-radius: 1.5rem;
        background-color: var(--cor-fundo-card);
        border: 1px solid var(--cor-borda);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease-in-out;
      }

      .chart-card:hover {
        transform: translateY(-5px);
        border-color: var(--cor-destaque);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .vehicle-card,
      #add-car-card,
      #client-register-card,
      #qrcode-container {
        background-color: var(--cor-fundo-card);
        border: 1px solid var(--cor-borda);
        border-radius: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
        backdrop-filter: blur(5px);
      }
      .kanban-column{
        background-color: var(--cor-fundo-card);
        border: 1px solid var(--cor-borda);
        border-radius: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
        backdrop-filter: blur(5px);
      }

      .vehicle-card:hover {
        transform: translateY(-5px);
        border-color: var(--cor-destaque);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .vehicle-card-image {
        height: 250px;
        overflow: hidden;
        border-bottom: 1px solid var(--cor-borda);
      }

      .vehicle-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .vehicle-card-image img[onload] {
        opacity: 1;
      }

      .vehicle-card-content {
        padding: 1.5rem;
        text-align: left;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .vehicle-card h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--cor-texto-principal);
        font-weight: 600;
      }

      .vehicle-card p {
        color: var(--cor-texto-secundario);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
      }

      .card-buttons {
        padding: 0 1.5rem 1.5rem;
        text-align: center;
      }

      .details-button {
        display: inline-flex;
        width: 100%;
        padding: 0.75rem;
        background-color: var(--cor-destaque);
        color: var(--cor-fundo-escuro);
        border: 2px solid transparent;
        border-radius: 0.75rem;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        text-transform: uppercase;
        box-shadow: 0 4px 10px rgba(0, 245, 255, 0.3);
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
      }

      .details-button:hover {
        background-color: var(--cor-destaque-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 245, 255, 0.4);
      }

      .details-button svg {
        fill: var(--cor-fundo-escuro);
        width: 1rem;
        height: 1rem;
      }

      .delete-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background-color: rgba(239, 68, 68, 0.8);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        background-color: var(--cor-danger);
        transform: scale(1.1) rotate(15deg);
      }

      #add-car-container,
      #client-register-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
      }

      #add-car-card,
      #client-register-card {
        padding: 2.5rem;
        width: 100%;
        max-width: 500px;
      }

      #add-car-card h3,
      #client-register-card h3 {
        font-family: "Poppins", sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      input,
      textarea,
      select {
        padding: 1rem;
        border: 1px solid var(--cor-borda);
        border-radius: 0.75rem;
        font-size: 1rem;
        color: var(--cor-texto-principal);
        background-color: var(--cor-fundo-escuro);
        width: 100%;
        transition: all 0.3s ease;
        margin-bottom: 1.25rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      select {
        padding-right: 2.5rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394A3B8' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1em;
        cursor: pointer;
      }

      select option {
        background: var(--cor-fundo-escuro);
        color: var(--cor-texto-principal);
      }

      input:focus,
      textarea:focus,
      select:focus {
        border-color: var(--cor-destaque);
        box-shadow: 0 0 10px rgba(0, 245, 255, 0.4);
        background-color: var(--cor-fundo-card);
        outline: none;
      }

      input[readonly] {
        cursor: not-allowed;
        background-color: rgba(255, 255, 255, 0.03);
        color: var(--cor-texto-secundario);
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        margin-bottom: 1rem;
      }

      .step-buttons {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .client-type-buttons,
      .payment-type-buttons,
      .car-interest-list,
      #trade-in-options {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
      }

      .client-type-buttons .btn,
      .payment-type-buttons .btn,
      #trade-in-options .btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .car-interest-list {
        list-style: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
        gap: 0.75rem;
      }

      .car-interest-list li {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--cor-borda);
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .car-interest-list li:hover {
        transform: translateX(5px);
        background: rgba(0, 245, 255, 0.05);
        border-color: var(--cor-destaque);
      }

      .car-interest-list li.selected {
        border: 2px solid var(--cor-destaque);
        background: rgba(0, 245, 255, 0.1);
        transform: scale(1.02);
      }

      .car-interest-list img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 0.5rem;
      }

      .car-interest-list .car-info {
        flex-grow: 1;
      }

      .progress-dots {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .progress-dot {
        width: 0.6rem;
        height: 0.6rem;
        background: var(--cor-borda);
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .progress-dot.active {
        background: var(--cor-destaque);
        transform: scale(1.3);
      }

      .photo-upload {
        border: 2px dashed var(--cor-borda);
        padding: 2rem;
        border-radius: 0.75rem;
        text-align: center;
        background: rgba(255, 255, 255, 0.03);
        transition: border-color 0.3s ease;
      }
      .photo-upload p {
        color: var(--cor-texto-secundario);
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }

      .photo-upload.dragover {
        border-color: var(--cor-destaque);
        background: rgba(0, 245, 255, 0.1);
      }

      .photo-upload input[type="file"] {
        display: none;
      }

      .photo-upload label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--cor-destaque);
        color: var(--cor-fundo-escuro);
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        text-transform: uppercase;
        box-shadow: 0 4px 10px rgba(0, 245, 255, 0.3);
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
      }

      .photo-upload label svg {
        width: 1.2rem;
        height: 1.2rem;
        fill: var(--cor-fundo-escuro);
      }

      .photo-upload label:hover {
        background-color: var(--cor-destaque-hover);
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 5px 15px rgba(0, 245, 255, 0.4);
      }

      .photo-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
        justify-content: center;
      }

      .photo-preview div {
        position: relative;
      }

      .photo-preview img {
        width: 6rem;
        height: 6rem;
        object-fit: cover;
        border-radius: 0.75rem;
      }

      .remove-photo {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: rgba(239, 68, 68, 0.8);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-photo svg {
        width: 0.8rem;
        height: 0.8rem;
        fill: #fff;
      }

      .remove-photo:hover {
        transform: scale(1.1);
        background-color: #dc2626;
      }

      .add-more-photo {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 6rem;
        height: 6rem;
        border: 2px dashed var(--cor-borda);
        border-radius: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .add-more-photo:hover {
        border-color: var(--cor-destaque);
        background: rgba(0, 245, 255, 0.1);
      }

      .add-more-photo svg {
        width: 2rem;
        height: 2rem;
        fill: var(--cor-texto-secundario);
      }

      #qrcode-container {
        text-align: center;
        padding: 2.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 20rem;
      }

      #qrcode-container img {
        max-width: 80%;
        border-radius: 0.75rem;
        border: 1.5px solid var(--cor-borda);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
      }

      #qrcode-container img:hover {
        transform: scale(1.05);
      }

      #qrcode-container .no-qrcode {
        color: var(--cor-danger);
        font-weight: 500;
        font-size: 1.1rem;
        margin-top: 1rem;
      }

      .btn {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo-escuro);
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        text-transform: uppercase;
        box-shadow: 0 4px 10px rgba(0, 245, 255, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn.secondary {
        background-color: transparent;
        color: var(--cor-destaque);
        border: 1px solid var(--cor-destaque);
        box-shadow: none;
      }

      .btn.secondary:hover {
        background-color: rgba(0, 245, 255, 0.1);
        transform: translateY(-1px);
      }

      .btn:hover {
        background-color: var(--cor-destaque-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 245, 255, 0.4);
      }

      .btn:disabled {
        background: var(--cor-borda);
        color: var(--cor-texto-secundario);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      #client-dialog,
      #delete-dialog {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--cor-fundo-card);
        padding: 2.5rem;
        border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
        color: var(--cor-texto-principal);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        text-align: left;
        animation: fadeIn 0.5s ease;
        z-index: 1001;
        border: 1px solid var(--cor-destaque);
      }

      #client-dialog h3,
      #delete-dialog h3 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--cor-destaque);
      }

      #client-dialog h4 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
      }

      #client-dialog p,
      #delete-dialog p {
        margin: 0.5rem 0;
        font-size: 1rem;
        color: var(--cor-texto-secundario);
      }

      .client-details-list {
        list-style: none;
        padding: 0;
      }

      .client-details-list li {
        margin: 0.5rem 0;
        font-size: 0.9rem;
      }

      .client-details-list img {
        max-width: 7.5rem;
        max-height: 7.5rem;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        transition: transform 0.3s ease;
      }

      .kanban-board {
        display: flex;
        gap: 1.5rem;
        padding-bottom: 1rem;
        transition: transform 0.4s ease-in-out;
      }

      .kanban-container {
        flex-grow: 1;
        display: flex;
        overflow: hidden;
      }

      .kanban-column {
        flex: 0 0 18rem;
        padding: 1.5rem;
        transition: background-color 0.3s ease;
        display: flex;
        flex-direction: column;
        max-height: 100%;
      }

      .kanban-column .client-list {
          flex-grow: 1;
          overflow-y: auto;
          padding-right: 0.5rem;
          margin-right: -0.5rem;
      }

      .kanban-column .client-list::-webkit-scrollbar {
        width: 8px;
      }
      .kanban-column .client-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }
      .kanban-column .client-list::-webkit-scrollbar-thumb {
        background-color: var(--cor-borda);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .kanban-column .client-list::-webkit-scrollbar-thumb:hover {
        background-color: var(--cor-destaque);
      }


      /* Estilos para o destaque das colunas do Kanban */
      .kanban-column h3 {
        font-size: 1.35rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--cor-destaque);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        display: flex; /* Adicionado para centralizar ícone e texto */
        align-items: center;
        justify-content: center;
        gap: 0.75rem; /* Espaçamento entre o ícone e o texto */
      }

      .kanban-column h3::after {
        content: '';
        display: block;
        width: 50px;
        height: 3px;
        background-color: var(--cor-destaque);
        margin: 0.5rem auto 0;
        border-radius: 2px;
        box-shadow: 0 0 8px var(--cor-destaque);
      }

      .kanban-column h3 i {
        font-size: 1.2em; /* Tamanho do ícone */
        color: inherit;
      }


      .client-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--cor-borda);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: move;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .client-card:hover {
        transform: translateY(-3px) scale(1.02);
        border-color: var(--cor-destaque);
        box-shadow: 0 6px 15px rgba(0, 245, 255, 0.2);
        background-color: rgba(0, 245, 255, 0.05);
      }
      .client-card .card-content {
        padding: 0;
        gap: 0.5rem;
      }
      .client-card h4 {
        font-size: 1.1rem;
        margin: 0;
        color: var(--cor-texto-principal);
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .client-card p {
        font-size: 0.9rem;
        color: var(--cor-texto-secundario);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .client-card p strong {
        color: var(--cor-texto-principal);
      }

      .client-card .delete-btn {
        top: 0.5rem;
        right: 0.5rem;
      }

      .client-card .details-button {
        margin-top: 1rem;
        padding: 0.75rem;
      }

      .search-box {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid var(--cor-borda);
        border-radius: 0.75rem;
        background: var(--cor-fundo-escuro);
        color: var(--cor-texto-principal);
        font-family: inherit;
        font-size: 1rem;
        flex-shrink: 0;
      }
      .search-box::placeholder {
        color: var(--cor-texto-secundario);
      }

      .top-scrollbar-container {
        display: none;
      }
      .top-scrollbar-content {
        height: 1px;
      }

      .kanban-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-shrink: 0;
      }

      .page-btn {
        background-color: transparent;
        border: 1px solid var(--cor-borda);
        color: var(--cor-texto-secundario);
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        cursor: pointer;
        font-weight: 600;
        font-family: "Poppins", sans-serif;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .page-btn:hover {
        background-color: rgba(0, 245, 255, 0.1);
        border-color: var(--cor-destaque);
        color: var(--cor-destaque);
      }

      .page-btn.active {
        background-color: var(--cor-destaque);
        border-color: var(--cor-destaque);
        color: var(--cor-fundo-escuro);
        box-shadow: 0 0 10px rgba(0, 245, 255, 0.4);
        transform: scale(1.1);
      }

      .gu-mirror {
        opacity: 0.8;
        transform: rotate(3deg);
      }

      .gu-transit {
        opacity: 0.3;
      }

      .chart-card h3 {
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
        text-align: center;
        font-weight: 600;
      }

      .doughnut-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 3rem;
        flex-wrap: wrap;
      }

      .doughnut-wrapper .canvas-wrapper {
        position: relative;
        height: 350px;
        width: 350px;
        flex-shrink: 0;
      }

      .chart-legend {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        flex: 0 1 180px;
      }

      .chart-legend li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .legend-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .legend-color-box {
        width: 14px;
        height: 14px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .legend-value {
        color: var(--cor-texto-secundario);
        font-weight: 500;
      }

      .sidebar {
        background-color: var(--cor-fundo-card);
        border-right: 1px solid var(--cor-borda);
        padding-top: 2rem;
        min-height: 100vh;
        width: 17rem;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        transform: translateX(0);
        transition: transform 0.4s ease-in-out;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .sidebar-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 1.5rem;
      }

      .hamburger-menu {
        display: none;
      }

      .hamburger-menu svg {
        width: 30px;
        height: 30px;
        fill: var(--cor-texto-principal);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }

        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @media (max-width: 1024px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          position: fixed;
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
          box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
        }

        .hamburger-menu {
          display: flex;
          position: fixed;
          top: 1rem;
          left: 1rem;
          z-index: 1200;
          cursor: pointer;
          flex-direction: column;
          gap: 5px;
          padding: 10px;
        }

        .hamburger-menu .bar {
          width: 25px;
          height: 3px;
          background-color: var(--cor-texto-principal);
          transition: all 0.3s ease-in-out;
        }

        .overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          z-index: 900;
        }

        .overlay.active {
          display: block;
        }

        .container {
          padding: 1rem;
          margin-top: 4rem;
          margin-left: 0;
          padding-left: 1rem;
          width: 100%;
        }

        .tab-content {
          padding: 1.5rem;
        }

        .tab-content h2 {
          font-size: 1.5rem;
          margin-bottom: 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="hamburger-menu" id="hamburger-menu">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M4 6h16v2H4zm0 5h16v-2H4zm0 5h16v-2H4z" />
      </svg>
    </div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="#" class="logo">ZAILONSOFT</a>
      </div>
      <nav class="nav">
        <a href="#" onclick="showTab('dashboard')" class="active">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M3 13h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V7H3v2zm0-4v2h18V5H3z" />
          </svg>
          Dashboard
        </a>
        <a href="#" onclick="showTab('catalog')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10S2 17.52 2 12A10 10 0 0 1 12 2zm-1 6h2v4h4v2h-4v4h-2v-4H7v-2h4V8z"
            />
          </svg>
          Catálogo
        </a>
        <a href="#" onclick="showTab('crm')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M21 4h-4.22a5 5 0 0 0-9.56 0H3c-.55 0-1 .45-1 1v12c0 .55.45 1 1 1h2v3c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3h2c.55 0 1-.45 1-1V5c0-.55-.45-1-1-1zm-9-2a3 3 0 0 1 3 3v2H9V5a3 3 0 0 1 3-3zM8 17H5V8h3v9zm11 0h-3V8h3v9z"
            />
          </svg>
          CRM
        </a>
        <a href="#" onclick="showTab('client-register')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm4 9.17h-3.17v3.17H11.83V13.17H8.66v-2.34h3.17V7.66h2.34v3.17h3.17v2.34z"
            />
          </svg>
          Cadastro de Clientes
        </a>
        <a href="#" onclick="showTab('qrcode')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M11 2h2v4h-2zm-3 0h2v4H8zM5 2h2v4H5zm6 7h2v2h-2zm-3 0h2v2H8zm-3 0h2v2H5zm6 4h2v2h-2zm-3 0h2v2H8zm-3 0h2v2H5zm8-13h-2v2h2v-2zm-3 0h-2v2h2v-2zm-3 0h-2v2h2v-2zm-1 12H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2zM3 21v-8h8v8H3zm12-9h-2v2h2v-2zm-2 2h-2v2h2v-2zm0 2h-2v2h2v-2zm2-2h2v2h-2v-2zm0-2h2v2h-2v-2zm0 4h2v2h-2v-2zM15 9h-2v2h2v-2zM17 9h-2v2h2v-2zM15 7h-2v2h2v-2zM17 7h-2v2h2v-2zM19 9h-2v2h2v-2zM21 9h-2v2h2v-2zM19 7h-2v2h2v-2zM21 7h-2v2h2v-2zM23 9h-2v2h2v-2zM23 7h-2v2h2v-2zM13 15h-2v2h2v-2zm-2 2h-2v2h2v-2zm-2 2h-2v2h2v-2zm-2 2h-2v2h2v-2zm2 2h2v2h-2v-2zM15 15h2v2h-2v-2zm0 2h2v2h-2v-2zM17 17h2v2h-2v-2zm0 2h2v2h-2v-2zM17 15h2v2h-2v-2zm2 2h2v2h-2v-2zm2 2h2v2h-2v-2zm-2 0h-2v2h2v-2z"
            />
          </svg>
          Conexão WhatsApp
        </a>
        <a href="#" onclick="showTab('add-car')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm4 9.17h-3.17v3.17H11.83V13.17H8.66v-2.34h3.17V7.66h2.34v3.17h3.17v2.34z"
            />
          </svg>
          Cadastro de Veículos
        </a>
      </nav>
    </div>
    <div class="overlay" id="overlay"></div>

    <div class="container">
      
      <div id="dashboard" class="tab-content active">
        <h2>Dashboard de Métricas</h2>

        <div class="dashboard-metrics">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
              <h3>Clientes Totais</h3>
              <p id="total-clients">0</p>
            </div>
          </div>
          <div class="metric-card success">
            <div class="metric-icon">
              <i class="fas fa-handshake"></i>
            </div>
            <div class="metric-content">
              <h3>Atendimentos Concluídas</h3>
              <p id="total-sales">0</p>
            </div>
          </div>
          <div class="metric-card danger">
            <div class="metric-icon">
              <i class="fas fa-thumbs-down"></i>
            </div>
            <div class="metric-content">
              <h3>Leads Perdidos</h3>
              <p id="lost-leads">0</p>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <h3>Tempo Médio de Resposta</h3>
              <p id="average-response-time">0s</p>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <h3>Distribuição de Clientes por Estado</h3>
          <div class="doughnut-wrapper">
            <div class="canvas-wrapper">
              <canvas id="statusDoughnutChart"></canvas>
            </div>
            <ul id="status-legend-list" class="chart-legend"></ul>
          </div>
        </div>

        <div class="chart-card">
          <h3>Clientes por Tipo de Pagamento</h3>
          <div
            class="canvas-wrapper"
            style="position: relative; height: 380px; width: 100%"
          >
            <canvas id="paymentBarChart"></canvas>
          </div>
        </div>
      </div>


      <div id="catalog" class="tab-content">
        <h2>Gerenciar Veículos</h2>
        <div class="card-grid" id="car-list"></div>
      </div>

      <div id="crm" class="tab-content">
        <h2>Gerenciar Clientes</h2>
        
        <div id="kanban-pagination" class="kanban-pagination"></div>

        <div class="top-scrollbar-container" id="top-scrollbar-container">
            <div class="top-scrollbar-content" id="top-scrollbar-content"></div>
        </div>

        <input
          type="text"
          id="client-search"
          class="search-box"
          placeholder="Buscar cliente, veículo ou tipo de negociação..."
        />
        <div class="kanban-container">
            <div class="kanban-board" id="kanban-board"></div>
        </div>
      </div>

      <div id="client-register" class="tab-content">
        <h2>Cadastro de Clientes</h2>
        <div id="client-register-container">
          <div id="client-register-card" class="active">
            <h3 id="client-step-title">Etapa 1: Selecione o Tipo de Cliente</h3>
            <div id="form-content-area" style="text-align: center">
              <div class="client-type-buttons">
                <button class="btn" onclick="startClientFlow('troca')">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-refresh-ccw"
                  >
                    <path d="M2.5 15.5V11a9 9 0 0 1 9-9h0a9 9 0 0 1 9 9v0" />
                    <path d="M21.5 8.5V13a9 9 0 0 1-9 9h0a9 9 0 0 1-9-9v0" />
                  </svg>
                  Troca
                </button>
                <button class="btn" onclick="startClientFlow('visita')">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-map-pin"
                  >
                    <path
                      d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                    ></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  Visita
                </button>
                <button class="btn" onclick="startClientFlow('comum')">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-shopping-cart"
                  >
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path
                      d="M1 1h4l2.68 12.08a2 2 0 0 0 2 1.92h9.44a2 2 0 0 0 2-1.68L23 5H6"
                    ></path>
                  </svg>
                  Venda
                </button>
              </div>
            </div>
            <div class="step-buttons" style="display: none">
              <button
                class="btn secondary"
                id="client-prev-btn"
                onclick="prevClientStep()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  width="20"
                  height="20"
                >
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                </svg>
                Voltar
              </button>
              <button class="btn" id="client-next-btn" onclick="nextClientStep()">
                Próximo
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  width="20"
                  height="20"
                >
                  <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
                </svg>
              </button>
            </div>
            <div class="progress-dots" style="display: none"></div>
          </div>
        </div>
      </div>

      <div id="qrcode" class="tab-content">
        <h2>Conexão WhatsApp</h2>
        <div id="qrcode-container">
          <img
            id="qrcode-img"
            src="http://localhost:5000/QRCODE/qrcode.png"
            alt="QR Code para Conexão WhatsApp"
            onerror="this.style.display='none'; document.getElementById('no-qrcode-msg').style.display='block';"
          />
          <div id="no-qrcode-msg" class="no-qrcode" style="display: none">
            O servidor está aguardando a geração do QR Code.
          </div>
          <button class="btn" onclick="refreshQR()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              width="20"
              height="20"
            >
              <path
                d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
              />
            </svg>
            Atualizar QRcode
          </button>
        </div>
        <p
          id="connection-status"
          style="margin-top: 15px; text-align: center; font-weight: 500"
        ></p>
      </div>

      <div id="add-car" class="tab-content">
        <h2>Cadastro de Veículos</h2>
        <div id="add-car-container">
          <div id="add-car-card" class="active">
            <h3 id="step-title">Etapa 1: Nome do Veículo</h3>
            <input
              type="text"
              id="car-input"
              placeholder="Digite o nome do veículo"
              required
            />
            <div class="step-buttons">
              <button
                class="btn secondary"
                id="prev-btn"
                style="display: none"
                onclick="prevStep()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  width="20"
                  height="20"
                >
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                </svg>
                Voltar
              </button>
              <button class="btn" id="next-btn" onclick="nextStep()">
                Próximo
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  width="20"
                  height="20"
                >
                  <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
                </svg>
              </button>
            </div>
            <div class="progress-dots">
              <div class="progress-dot active"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
              <div class="progress-dot"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="client-dialog">
        <h3>Detalhes do Cliente</h3>
        <p><strong>Chat ID:</strong> <span id="client-chat-id"></span></p>
        <p><strong>Nome:</strong> <span id="client-name"></span></p>
        <p><strong>Telefone:</strong> <span id="client-phone"></span></p>
        <p><strong>CPF:</strong> <span id="client-cpf"></span></p>
        <p><strong>RG:</strong> <span id="client-rg"></span></p>
        <p><strong>Ocupação:</strong> <span id="client-job"></span></p>
        <p><strong>Estado:</strong> <span id="client-state"></span></p>
        <p><strong>Relatório:</strong> <span id="client-report"></span></p>
        <h4>Documentos</h4>
        <ul class="client-details-list" id="client-documents"></ul>
        <h4>Veículos de Interesse</h4>
        <ul
          class="client-details-list"
          id="client-interested-vehicles"
        ></ul>
        <h4>Financiamento</h4>
        <p><strong>Carro Escolhido:</strong> <span id="client-finance-car"></span></p>
        <p><strong>Entrada:</strong> <span id="client-finance-entry"></span></p>
        <p><strong>Parcelas:</strong> <span id="client-finance-parcels"></span></p>
        <p>
          <strong>Valor a Financiar:</strong> <span id="client-finance-amount"></span>
        </p>
        <h4>Visita</h4>
        <p><strong>Dia:</strong> <span id="client-visit-day"></span></p>
        <p><strong>Horário:</strong> <span id="client-visit-time"></span></p>
        <p><strong>Nome:</strong> <span id="client-visit-name"></span></p>
        <h4>Carro para Troca</h4>
        <p><strong>Modelo:</strong> <span id="client-trade-model"></span></p>
        <p><strong>Ano:</strong> <span id="client-trade-year"></span></p>
        <p><strong>Estado:</strong> <span id="client-trade-condition"></span></p>
        <p><strong>Foto:</strong> <span id="client-trade-photo"></span></p>
        <h4>Histórico</h4>
        <ul class="client-details-list" id="client-history"></ul>
        <button class="btn" onclick="closeDialog()">Fechar</button>
      </div>
      <div id="delete-dialog">
        <h3>Confirmar Exclusão</h3>
        <p>Tem certeza que deseja excluir este veículo?</p>
        <div
          style="margin-top: 15px; display: flex; gap: 10px; justify-content: center"
        >
          <button class="btn" onclick="confirmDelete()">Deletar</button>
          <button class="btn" onclick="closeDeleteDialog()">Cancelar</button>
        </div>
      </div>
    </div>
    
    <div id="custom-alert-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; backdrop-filter: blur(5px);"></div>
    <div id="custom-alert-box" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--cor-fundo-card); color: var(--cor-texto-principal); padding: 2rem; border-radius: 1.5rem; border: 1px solid var(--cor-borda); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2001; text-align: center; min-width: 300px;">
      <h3 id="custom-alert-title" style="color: var(--cor-destaque); margin-bottom: 1rem; font-size: 1.5rem;"></h3>
      <p id="custom-alert-message" style="margin-bottom: 2rem;"></p>
      <button id="custom-alert-ok" class="btn">OK</button>
    </div>
    <script>
      // --- INÍCIO DAS FUNÇÕES DE FORMATAÇÃO (CORRIGIDAS E CENTRALIZADAS) ---
      /**
       * Converte um valor (número ou string) para uma string de moeda BRL formatada.
       * Ex: toBRL(25000.50) -> "R$ 25.000,50"
       * @param {*} value O valor a ser formatado.
       * @returns {string} A string de moeda formatada ou um texto padrão.
       */
      function toBRL(value) {
          if (value === null || value === undefined || value === '') return "Não informado";
          const num = parseCurrency(value);
          return num.toLocaleString("pt-BR", {
              style: "currency",
              currency: "BRL",
          });
      }

      /**
       * Formata o valor de um CAMPO DE INPUT <input> como moeda BRL enquanto o usuário digita.
       * @param {HTMLInputElement} input O elemento input a ser formatado.
       */
      function formatCurrencyInput(input) {
          let value = input.value.replace(/\D/g, "");
          if (value === "") {
              input.value = "";
              return;
          }
          const numValue = parseInt(value, 10) / 100;
          input.value = numValue.toLocaleString("pt-BR", {
              style: "currency",
              currency: "BRL"
          });
      }
      
      /**
       * Extrai o valor numérico de uma string de moeda formatada ou de um número.
       * Ex: parseCurrency("R$ 25.000,50") -> 25000.5
       * @param {string|number} value A string ou número.
       * @returns {number} O valor numérico.
       */
      function parseCurrency(value) {
          if (typeof value === 'number') return value;
          if (!value) return 0;
          const numberString = String(value).replace(/[^0-9,]/g, "").replace(",", ".");
          return parseFloat(numberString) || 0;
      }

      /**
       * Formata um total de segundos em uma string de tempo legível (anos, meses, dias, h, m, s).
       * @param {number} totalSeconds O total de segundos a ser formatado.
       * @returns {string} A string de tempo formatada.
       */
      function formatDuration(totalSeconds) {
          if (totalSeconds < 0 || isNaN(totalSeconds)) return "0s";
          if (totalSeconds < 60) return `${Math.round(totalSeconds)}s`;

          const years = Math.floor(totalSeconds / 31536000);
          if (years > 0) return `${years}a`;

          const months = Math.floor(totalSeconds / 2592000);
          if (months > 0) return `${months}mês`;

          const days = Math.floor(totalSeconds / 86400);
          if (days > 0) return `${days}d`;
          
          const hours = Math.floor(totalSeconds / 3600);
          if (hours > 0) return `${hours}h`;

          const minutes = Math.floor(totalSeconds / 60);
          const seconds = Math.round(totalSeconds % 60);
          
          return `${minutes}m ${seconds}s`;
      }
      // --- FIM DAS FUNÇÕES DE FORMATAÇÃO ---

      let cars = {};
      let allClients = [];
      let currentStep = 1;
      let carData = {
        files: [],
      };
      let clientStep = 0;
      let clientType = null;
      let clientPaymentType = null;
      let clientData = {
        trade_in_photos: [],
        documents: [],
        interested_vehicles: [],
        financing_details: {},
        visit_details: {},
        trade_in_car: {},
      };
      let carToDelete = null;
      let checkStatusInterval;
      let kanbanColumns = [];
      let drake = null;
      let lastClientHash = null;
      let pollClientsInterval = null;
      let isDragging = false;
      let availableCars = [];
      const dealTypeMap = {
        comum: "Venda",
        troca: "Troca",
        visita: "Visita",
        a_vista: "À Vista",
        financiamento: "Financiamento",
        "financiamento_com_troca": "Financiamento e Troca",
      };

      let currentPage = 1;
      const columnsPerPage = 3;
      let totalPages = 1;
      let dragNavigationTimeout = null;
      
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.getElementById("overlay").classList.toggle("active");
      }

      async function loadCars() {
        try {
          const response = await fetch("http://localhost:5000/api/cars");
          if (!response.ok)
            throw new Error(`Erro ao carregar carros: ${response.statusText}`);
          cars = await response.json();
          availableCars = cars.modelos || [];
          renderCars();
        } catch (error) {
          console.error("Erro ao carregar dados:", error);
          document.getElementById(
            "car-list"
          ).innerHTML = `<p style="color: #EF4444; text-align: center; font-weight: 500;">Erro ao carregar carros. Verifique o servidor.</p>`;
        }
      }
      
      function getClientColumnId(state) {
        if (!state) return "leed_recebido";
        if (state.startsWith("troca_")) return "dados_troca";
        if (state.startsWith("visita_")) return "dados_visita";
        if (state.startsWith("financiamento_") || state.startsWith("a_vista_")) return "dados_financiamento";
        
        const directMap = [
            "leed_recebido",
            "aguardando_interesse",
            "aguardando_escolha_carro",
            "aguardando_confirmacao_veiculo",
            "aguardando_opcao_pagamento",
            "finalizado"
        ];

        if (directMap.includes(state)) {
            return state;
        }

        return "leed_recebido";
      }

      async function loadKanbanStates() {
        try {
          const response = await fetch("http://localhost:5000/api/clients");
          if (!response.ok)
            throw new Error(
              `Erro ao carregar clientes: ${response.statusText}`
            );
          const data = await response.json();
          allClients = data.clients || data || [];

          kanbanColumns = [
            { id: "leed_recebido", name: "Novo Lead", icon: "fas fa-user-plus" },
            { id: "aguardando_interesse", name: "Aguardando Interesse", icon: "fas fa-spinner" },
            { id: "aguardando_escolha_carro", name: "Aguardando Escolha", icon: "fas fa-car" },
            { id: "aguardando_confirmacao_veiculo", name: "Aguardando Confirmação", icon: "fas fa-check-circle" },
            { id: "aguardando_opcao_pagamento", name: "Aguardando Pagamento", icon: "fas fa-credit-card" },
            { id: "dados_troca", name: "Dados de Troca", icon: "fas fa-exchange-alt" },
            { id: "dados_visita", name: "Dados de Visita", icon: "fas fa-map-marked-alt" },
            { id: "dados_financiamento", name: "Dados de Financiamento", icon: "fas fa-file-invoice-dollar" },
            { id: "finalizado", name: "Atendimento Finalizado", icon: "fas fa-check-double" },
          ];

        } catch (error) {
          console.error("Erro ao carregar estados do Kanban:", error);
          kanbanColumns = [
            { id: "leed_recebido", name: "Novo Lead", icon: "fas fa-user-plus" },
            { id: "finalizado", name: "Finalizado", icon: "fas fa-check-double" },
          ];
        }
      }
      
      function goToPage(page) {
          if (page < 1 || page > totalPages) return;
          currentPage = page;

          const board = document.getElementById('kanban-board');
          if (!board || board.children.length === 0) return;

          const columnElement = board.querySelector('.kanban-column');
          const boardStyles = window.getComputedStyle(board);
          const columnWidth = columnElement.offsetWidth;
          const gap = parseFloat(boardStyles.gap);
          const offset = (columnWidth + gap) * columnsPerPage * (currentPage - 1);
          board.style.transform = `translateX(-${offset}px)`;

          const paginationContainer = document.getElementById('kanban-pagination');
          const buttons = paginationContainer.querySelectorAll('.page-btn');
          buttons.forEach((btn, index) => {
              btn.classList.toggle('active', (index + 1) === currentPage);
          });
      }

      function renderPaginationControls() {
          const paginationContainer = document.getElementById('kanban-pagination');
          const board = document.getElementById('kanban-board');
          if (!paginationContainer || !board) return;

          const totalColumns = board.children.length;
          totalPages = Math.ceil(totalColumns / columnsPerPage);
          paginationContainer.innerHTML = '';

          if (totalPages <= 1) {
              paginationContainer.style.display = 'none';
              return;
          }
          paginationContainer.style.display = 'flex';

          for (let i = 1; i <= totalPages; i++) {
              const pageBtn = document.createElement('button');
              pageBtn.className = 'page-btn';
              pageBtn.textContent = i;
              pageBtn.onclick = () => goToPage(i);
              paginationContainer.appendChild(pageBtn);
          }
      }

      function handleDragWhileMoving(e) {
          if (dragNavigationTimeout) return;

          const container = document.getElementById('kanban-container');
          if (!container) return;

          const containerRect = container.getBoundingClientRect();
          const triggerZoneWidth = 80;

          if (e.clientX > containerRect.right - triggerZoneWidth && currentPage < totalPages) {
              goToPage(currentPage + 1);
              dragNavigationTimeout = setTimeout(() => { dragNavigationTimeout = null; }, 600);
          } else if (e.clientX < containerRect.left + triggerZoneWidth && currentPage > 1) {
              goToPage(currentPage - 1);
              dragNavigationTimeout = setTimeout(() => { dragNavigationTimeout = null; }, 600);
          }
      }

      function renderKanbanBoard(clients) {
          const board = document.getElementById("kanban-board");
          board.innerHTML = "";
          kanbanColumns.forEach((column) => {
              const colElement = document.createElement("div");
              colElement.className = "kanban-column";
              colElement.id = column.id;
              colElement.innerHTML = `<h3><i class="${column.icon}"></i> ${column.name}</h3><div class="client-list"></div>`;
              board.appendChild(colElement);
          });
          
          if (clients && Array.isArray(clients) && clients.length > 0) {
              const columns = {};
              kanbanColumns.forEach((col) => {
                  const colElement = document.getElementById(col.id);
                  if (colElement) columns[col.id] = colElement.querySelector(".client-list");
              });
              
              clients.forEach((client) => {
                  const clientState = getClientColumnId(client.bot_data?.state);
                  const card = document.createElement("div");
                  card.className = "client-card";
                  card.dataset.chatId = client.chat_id;
                  card.setAttribute("draggable", "true");

                  let interestedVehicle = "Nenhum";
                  const vehicles = client.bot_data?.interested_vehicles || client.interested_vehicles;
                  if (Array.isArray(vehicles) && vehicles.length > 0) {
                      interestedVehicle = vehicles.map(v => v?.nome || 'Veículo').join(", ");
                  } else if (vehicles?.nome) {  
                      interestedVehicle = vehicles.nome;
                  }

                  let dealType = "Não Informada";
                  const dealTypeKey = client.deal_type || client.bot_data?.deal_type;
                  if (dealTypeKey) {
                      dealType = dealTypeMap[dealTypeKey] || dealTypeKey;
                  }
                  
                  card.innerHTML = `
                      <h4>${client.name || "Desconhecido"}</h4>
                      <div class="card-content">
                          <p><strong>Veículo:</strong> ${interestedVehicle}</p>
                          <p><strong>Negociação:</strong> ${dealType}</p>
                      </div>
                      <button class="details-button" onclick="showClientDetails('${client.chat_id}')">
                          Detalhes
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M.046 8.5c.66 1.838 2.373 3.5 4.954 3.5 2.58 0 4.293-1.662 4.954-3.5H.046zM12 12c-2.58 0-4.293-1.662-4.954-3.5h9.908c-.66 1.838-2.373 3.5-4.954 3.5zM12 4a3.5 3.5 0 0 0-3.5 3.5c0 1.933 1.567 3.5 3.5 3.5s3.5-1.567 3.5-3.5S13.933 4 12 4z"/></svg>
                      </button>
                      <button class="delete-btn" onclick="openDeleteClientDialog('${client.chat_id}')">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: middle;"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" /><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                      </button>
                      `;
                  if (columns[clientState]) {
                      columns[clientState].appendChild(card);
                  } else {
                      console.warn(
                          `Estado inválido para o cliente ${client.chat_id}: ${clientState}`
                      );
                      if (columns.leed_recebido) columns.leed_recebido.appendChild(card);
                  }
              });
          }
          
          if (drake) drake.destroy();
          const containers = kanbanColumns
              .map((col) => document.getElementById(col.id)?.querySelector(".client-list"))
              .filter(Boolean);
          if (containers.length === 0) return;
          drake = dragula(containers, {
              moves: (el, source, handle, sibling) =>
                  !handle.classList.contains("details-button") &&
                  !handle.classList.contains("delete-btn"),
          });

          drake.on("drag", () => {
              isDragging = true;
              document.addEventListener('mousemove', handleDragWhileMoving);
          });
          drake.on("dragend", () => {
              isDragging = false;
              document.removeEventListener('mousemove', handleDragWhileMoving);
              clearTimeout(dragNavigationTimeout);
              dragNavigationTimeout = null;
          });
          drake.on("cancel", () => {
              isDragging = false;
              document.removeEventListener('mousemove', handleDragWhileMoving);
              clearTimeout(dragNavigationTimeout);
              dragNavigationTimeout = null;
          });

          drake.on("drop", async (el, target, source, sibling) => {
              isDragging = false;
              if (!target) {
                  console.warn("Target do drop não encontrado");
                  drake.cancel(true);
                  return;
              }
              const chatId = el.dataset.chatId;
              const newState = target.parentElement.id;
              try {
                  const clientResponse = await fetch(
                      `http://localhost:5000/api/clients/${chatId}`
                  );
                  if (!clientResponse.ok)
                      throw new Error(
                          `Cliente ${chatId} não encontrado. Não foi possível atualizar.`
                      );
                  const client = await clientResponse.json();
                  client.state = newState;
                  if (!client.bot_data) client.bot_data = {};
                  client.bot_data.state = newState;
                  if (!client.bot_data.history) client.bot_data.history = [];
                  client.bot_data.history.push({
                      timestamp: new Date().toLocaleString("pt-BR"),
                      updated_data: {
                          state: `Movido para ${newState} manualmente pelo CRM`,
                      },
                  });
                  const updateResponse = await fetch(
                      `http://localhost:5000/api/clients/${chatId}`, {
                          method: "PUT",
                          headers: {
                              "Content-Type": "application/json",
                          },
                          body: JSON.stringify(client),
                      }
                  );
                  if (!updateResponse.ok) {
                      const errorText = await updateResponse.text();
                      throw new Error(
                          `Erro ao atualizar estado: ${errorText || updateResponse.statusText}`
                      );
                  }
                  console.log(`Estado do cliente ${chatId} atualizado para ${newState}`);
                  await loadClients();
              } catch (error) {
                  console.error("Erro ao atualizar estado do cliente:", error);
                  showCustomAlert("Erro", `Erro ao mover o cliente: ${error.message}.`);
                  drake.cancel(true);
              }
          });
          
          renderPaginationControls();
          goToPage(currentPage);
      }

      function filterClients(query) {
        const lowerCaseQuery = query.toLowerCase();
        const filteredClients = allClients.filter(client => {
            const clientName = client.name?.toLowerCase() || '';
            
            let interestedVehicle = "";
            const vehicles = client.bot_data?.interested_vehicles || client.interested_vehicles;
            if (Array.isArray(vehicles) && vehicles.length > 0) {
                interestedVehicle = vehicles.map(v => v?.nome || '').join(", ").toLowerCase();
            } else if (vehicles?.nome) {
                interestedVehicle = vehicles.nome.toLowerCase();
            }

            const dealTypeKey = client.deal_type || client.bot_data?.deal_type;
            const dealType = (dealTypeMap[dealTypeKey] || (dealTypeKey || '')).toLowerCase();

            return clientName.includes(lowerCaseQuery) ||
                   interestedVehicle.includes(lowerCaseQuery) ||
                   dealType.includes(lowerCaseQuery);
        });
        
        currentPage = 1;
        renderKanbanBoard(filteredClients);
      }
      
      async function loadClients() {
        try {
          const response = await fetch("http://localhost:5000/api/clients");
          if (!response.ok)
            throw new Error(
              `Erro ao carregar clientes: ${response.statusText}`
            );
          const data = await response.json();
          allClients = data.clients || data || [];
          const currentHash = JSON.stringify(
            allClients.map((c) => ({
              chat_id: c.chat_id,
              state: c.bot_data?.state,
              lastUpdate: c.bot_data?.history?.slice(-1)[0]?.timestamp || "N/A",
            }))
          );
          if (currentHash !== lastClientHash) {
            lastClientHash = currentHash;
            renderKanbanBoard(allClients);
          }
          updateCrmDashboard(allClients);
        } catch (error) {
          console.error("Erro ao carregar clientes:", error);
          document.getElementById(
            "kanban-board"
          ).innerHTML = `<p style="color: #EF4444; text-align: center; font-weight: 500;">Erro ao carregar clientes. Verifique o servidor.</p>`;
        }
      }
      async function pollClients() {
        if (isDragging) return;
        try {
          const response = await fetch("http://localhost:5000/api/clients");
          if (!response.ok)
            throw new Error(
              `Erro ao verificar clientes: ${response.statusText}`
            );
          const data = await response.json();
          allClients = data.clients || data || [];
          const currentHash = JSON.stringify(
            allClients.map((c) => ({
              chat_id: c.chat_id,
              state: c.bot_data?.state,
              lastUpdate: c.bot_data?.history?.slice(-1)[0]?.timestamp || "N/A",
            }))
          );
          if (currentHash !== lastClientHash) {
            lastClientHash = currentHash;
            renderKanbanBoard(allClients);
          }
          updateCrmDashboard(allClients);
        } catch (error) {
          console.error("Erro ao atualizar clientes:", error);
        }
      }
      
      function showCustomAlert(title, message) {
          document.getElementById('custom-alert-title').textContent = title;
          document.getElementById('custom-alert-message').textContent = message;
          document.getElementById('custom-alert-overlay').style.display = 'block';
          document.getElementById('custom-alert-box').style.display = 'block';

          const okButton = document.getElementById('custom-alert-ok');
          
          const closeAlert = () => {
              document.getElementById('custom-alert-overlay').style.display = 'none';
              document.getElementById('custom-alert-box').style.display = 'none';
          };

          okButton.onclick = closeAlert;
      }

      async function saveClient() {
        const chatId = clientData.chatId || "web_" + Date.now();
        const clientPayload = {
          chat_id: chatId,
          name: clientData.name || "",
          phone: clientData.phone || "",
          cpf: clientData.cpf || "",
          job: clientData.job || "",
          state: clientData.state || "leed_recebido",
          report: clientData.report || `Cliente ${clientType} adicionado via CRM`,
          interested_vehicles: clientData.interested_vehicles || [],
          payment_method: clientData.payment_method || null,
          financing_details: clientData.financing_details || {},
          visit_details: clientData.visit_details || {},
          trade_in_car: clientData.trade_in_car || {},
          deal_type: clientType,
          bot_data: {
            state: clientData.state || "leed_recebido",
            interested_vehicles: clientData.interested_vehicles || [],
            financing_details: clientData.financing_details || {},
            visit_details: clientData.visit_details || {},
            trade_in_car: clientData.trade_in_car || {},
            history: clientData.history || [],
            deal_type: clientType // Garante que o tipo de negociação também fique no bot_data
          },
        };
        try {
          const method = clientData.chatId ? "PUT" : "POST";
          const url = clientData.chatId ?
            `http://localhost:5000/api/clients/${chatId}` :
            "http://localhost:5000/api/clients";
          const clientResponse = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clientPayload),
          });
          if (!clientResponse.ok)
            throw new Error(`Erro ao salvar cliente: ${await clientResponse.text()}`);

          const fileFormData = new FormData();
          let hasFiles = false;

          if (clientData.trade_in_photos?.length > 0) {
              clientData.trade_in_photos.forEach((file) => fileFormData.append("trade_in_photos", file));
              hasFiles = true;
          }
          if (clientData.documents?.length > 0) {
              clientData.documents.forEach((file) => fileFormData.append("documents", file));
              hasFiles = true;
          }

          if (hasFiles) {
              const fileResponse = await fetch(
                  `http://localhost:5000/api/clients/${chatId}/files`, {
                      method: "POST",
                      body: fileFormData,
                  }
              );
              if (!fileResponse.ok)
                  throw new Error(`Erro ao enviar arquivos: ${await fileResponse.text()}`);
          }

          resetClientForm();
          await loadClients();
          showTab("crm");
          showCustomAlert("Sucesso!", "Cliente cadastrado com sucesso.");
        } catch (error) {
          console.error("Erro ao salvar cliente:", error);
          showCustomAlert("Erro", `Erro ao salvar cliente: ${error.message}. Verifique o console.`);
        }
      }

      function resetClientForm() {
        clientData = {
          trade_in_photos: [],
          documents: [],
          interested_vehicles: [],
          financing_details: {},
          visit_details: {},
          trade_in_car: {},
        };
        clientStep = 0;
        clientType = null;
        clientPaymentType = null;
        updateClientStepContent();
      }

      function startClientFlow(type) {
        clientType = type;
        clientStep = 1;
        document.querySelector(".step-buttons").style.display = "flex";
        document.querySelector(".progress-dots").style.display = "flex";
        updateClientStepContent();
      }
      
      function selectPaymentType(type) {
        clientPaymentType = type;
        clientData.payment_method = type === "a_vista" ? "À Vista" : "Financiamento";
        if (clientType === "comum") {
          clientType = type === "a_vista" ? "a_vista" : "financiamento";
        }
        updateClientStepContent();
      }

      function handleTradeInOption(hasTradeIn) {
          clientData.trade_in_car = { has_trade: hasTradeIn };
          nextClientStep();
      }

      function toggleCarSelection(carId) {
        const carIndex = clientData.interested_vehicles.findIndex(
          (car) => car.id === carId
        );
        const carElement = document.getElementById(`car-${carId}`);
        if (carIndex > -1) {
          clientData.interested_vehicles.splice(carIndex, 1);
          carElement.classList.remove("selected");
        } else {
          const car = availableCars.find((c) => c.id === carId);
          if (car) {
            if (clientType === "comum" || clientType === "visita" || clientType === "financiamento") {
              clientData.interested_vehicles = [];
              document
                .querySelectorAll(".car-interest-list li")
                .forEach((li) => li.classList.remove("selected"));
            }
            clientData.interested_vehicles.push({
              id: car.id,
              nome: car.nome,
              preco: car.preco,
            });
            carElement.classList.add("selected");
          }
        }
        document.getElementById("client-next-btn").disabled =
          clientData.interested_vehicles.length === 0;
      }

      function showCarDetails(carId) {
        window.location.href = `car-details.html?id=${carId}`;
      }
      async function showClientDetails(chatId) {
        window.location.href = `clientes-detail.html?chatId=${chatId}`;
      }

      function openDeleteClientDialog(chatId) {
        document.getElementById("delete-dialog").innerHTML = `
        <h3>Confirmar Exclusão</h3> <p>Tem certeza que deseja excluir este cliente?</p>
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn" onclick="confirmDeleteClient('${chatId}')">Deletar</button>
            <button class="btn" onclick="closeDeleteDialog()">Cancelar</button>
        </div>`;
        document.getElementById("delete-dialog").style.display = "block";
      }
      async function confirmDeleteClient(chatId) {
        try {
          const response = await fetch(
            `http://localhost:5000/api/clients/${chatId}`, {
              method: "DELETE",
            }
          );
          if (!response.ok)
            throw new Error(
              `Erro ao deletar cliente: ${await response.text()}`
            );
          await loadClients();
          closeDeleteDialog();
        } catch (error) {
          console.error("Erro ao deletar cliente:", error);
          showCustomAlert("Erro", `Erro ao deletar o cliente: ${error.message}.`);
        }
      }
      
      function formatPhone(input) {
          let value = input.value.replace(/\D/g, "");
          
          if (value.length === 0) {
              input.value = "";
              return;
          }

          value = value.substring(0, 11);
          if (value.length > 10) {
              value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
          } else if (value.length > 5) {
              value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, "($1) $2-$3");
          } else if (value.length > 2) {
              value = value.replace(/^(\d*)/, "($1");
          } else {
              value = value.replace(/^(\d*)/, "($1");
          }
          input.value = value;
      }

      function updateFinancingAmount() {
        const amountInput = document.getElementById("client-input-financing_details-amount");
        if (!amountInput) return;

        const selectedCar = clientData.interested_vehicles[0];
        if (!selectedCar || !selectedCar.preco) {
            amountInput.value = "Selecione um carro";
            return;
        }
        
        const carPrice = parseCurrency(selectedCar.preco);
        const entryValue = clientData.financing_details?.entry || 0;
        const tradeInValue = clientData.trade_in_car?.value || 0;
        let amountToFinance = carPrice - entryValue - tradeInValue;
        if (amountToFinance < 0) amountToFinance = 0;

        clientData.financing_details.amount = amountToFinance;
        amountInput.value = toBRL(amountToFinance);
      }

      function nextClientStep() {
        const steps = getClientSteps();
        const stepInfo = steps[clientStep - 1];

        if (
          stepInfo.type !== "payment-type" &&
          stepInfo.type !== "trade-in-car-option" &&
          stepInfo.type !== "select-group" &&
          stepInfo.type !== "review"
        ) {
          const inputs = document.querySelectorAll(
            "#form-content-area input, #form-content-area select, #form-content-area textarea"
          );
          for (const input of inputs) {
            if (input.required && !input.value.trim()) {
              showCustomAlert("Campo Obrigatório", `Por favor, preencha o campo: ${input.placeholder || input.id}`);
              input.focus();
              return;
            }

            if (input.id === "client-input-phone") {
              const cleanValue = input.value.replace(/\D/g, "");
              if (cleanValue.length < 10) {
                showCustomAlert("Campo Inválido", "Por favor, insira um número de telefone válido (DDD + 8 ou 9 dígitos).");
                input.focus();
                return;
              }
            } else if (input.id === "client-input-cpf") {
              const cleanValue = input.value.replace(/\D/g, "");
              if (cleanValue.length > 0 && cleanValue.length !== 11) {
                showCustomAlert("Campo Inválido", "Por favor, insira um CPF válido com 11 dígitos.");
                input.focus();
                return;
              }
            } else if (input.id === "client-input-trade_in_car-year") {
              const cleanValue = input.value.replace(/\D/g, "");
              if (cleanValue.length !== 4) {
                showCustomAlert("Campo Inválido", "Por favor, insira um ano válido com 4 dígitos.");
                input.focus();
                return;
              }
            }
          }

          if (stepInfo.type === "list-selection" && clientData.interested_vehicles.length === 0) {
            showCustomAlert("Seleção Necessária", "Por favor, selecione pelo menos um veículo de interesse.");
            return;
          }
        }

        const inputs = document.querySelectorAll(
          "#form-content-area input, #form-content-area select, #form-content-area textarea"
        );
        inputs.forEach((input) => {
          if (input.readOnly) {
            return;
          }

          let value = input.value;
          let key = input.id.replace("client-input-", "").replace("-", ".");

          if (input.type === "tel" || key === "cpf") {
            value = value.replace(/\D/g, "");
          }
          if (key.includes('entry') || key.includes('value') || key.includes('price')) {
              value = parseCurrency(value);
          }

          if (key.includes(".")) {
            const [parent, child] = key.split(".");
            if (!clientData[parent]) clientData[parent] = {};
            clientData[parent][child] = value;
          } else {
            clientData[key] = value;
          }
        });
        
        clientStep++;
        updateClientStepContent();
      }

      function prevClientStep() {
        if (clientStep > 1) {
          clientStep--;
          const steps = getClientSteps();
          const stepInfo = steps[clientStep - 1];

          if (clientType === "financiamento" && stepInfo.type === "payment-type") {
            clientPaymentType = null;
            clientType = 'comum';
          }

          if (clientData.trade_in_car?.has_trade && stepInfo.type === 'trade-in-car-option') {
            clientData.trade_in_car = {};
          }
          
          updateClientStepContent();
        } else {
          resetClientForm();
        }
      }

      const commonSteps = [{
        title: "Dados Pessoais",
        type: "input-group",
        fields: [{
          type: "text",
          placeholder: "Nome do cliente",
          key: "name",
          required: true,
        }, {
          type: "tel",
          placeholder: "(DDD) 99999-9999",
          key: "phone",
          required: true,
        }, {
          type: "text",
          placeholder: "CPF (opcional)",
          key: "cpf",
          required: false,
        }, {
          type: "text",
          placeholder: "Ocupação (opcional)",
          key: "job",
          required: false,
        }, ],
      }, ];

      const tradeInCarSteps = [{
        title: "Detalhes do Carro de Troca",
        type: "input-group",
        fields: [{
          type: "text",
          placeholder: "Modelo do carro",
          key: "trade_in_car.model",
          required: true,
        }, {
          type: "text",
          placeholder: "Ano do carro",
          key: "trade_in_car.year",
          required: true,
        }, {
          type: "text",
          placeholder: "Valor do carro",
          key: "trade_in_car.value",
          inputmode: "decimal"
        }, ],
      }, {
        title: "Fotos do Carro de Troca",
        type: "photo-upload",
        key: "trade_in_photos",
        description: "Envie fotos do veículo que será usado na troca.",
        accept: "image/*",
      }, ];

      const documentUploadStep = {
          title: "Envio de Documentos",
          type: "photo-upload",
          key: "documents",
          description: "Envie fotos do RG, CPF e Comprovante de Residência.",
          accept: "image/*,application/pdf",
          required: false,
      };

      const clientSteps = {
        comum: [
          ...commonSteps, {
            title: "Veículo de Interesse",
            type: "list-selection",
            key: "interested_vehicles",
            required: true,
          }, {
            title: "Selecione o Tipo de Pagamento",
            type: "payment-type",
          },
        ],
        a_vista: [
          ...commonSteps, {
            title: "Veículo de Interesse",
            type: "list-selection",
            key: "interested_vehicles",
            required: true,
          }, {
            title: "Estado do Lead",
            type: "select",
            key: "state",
            required: true,
          }, {
            title: "Revisar Dados",
            type: "review",
          },
        ],
        financiamento: [
          ...commonSteps, {
            title: "Veículo de Interesse",
            type: "list-selection",
            key: "interested_vehicles",
            required: true,
          }, {
            title: "Tem carro para dar na troca?",
            type: "trade-in-car-option",
          }, {
            title: "Valor da Entrada",
            type: "input-group",
            fields: [{
              type: "text",
              placeholder: "Digite o valor da entrada",
              key: "financing_details.entry",
              required: true,
              inputmode: "decimal"
            }]
          }, {
            title: "Valor a Financiar",
            type: "input-group",
            fields: [{
              type: "text",
              key: "financing_details.amount",
              readonly: true,
              placeholder: "Valor a financiar",
            }]
          }, {
            title: "Quantidade de Parcelas",
            type: "select-group",
            options: [{ value: "12", label: "12x" }, { value: "24", label: "24x" }, { value: "36", label: "36x" }, { value: "48", label: "48x" }, { value: "60", label: "60x" }],
            key: "financing_details.parcels",
            required: true,
          },
          documentUploadStep,
          {
            title: "Estado do Lead",
            type: "select",
            key: "state",
            required: true,
          }, {
            title: "Revisar Dados",
            type: "review",
          },
        ],
        visita: [
          ...commonSteps, {
            title: "Detalhes da Visita",
            type: "input-group",
            fields: [{
              type: "date",
              placeholder: "Dia da visita",
              key: "visit_details.day",
              required: true,
            }, {
              type: "time",
              placeholder: "Horário da visita",
              key: "visit_details.time",
              required: true,
            }, ],
          }, {
            title: "Interesse no Catálogo",
            type: "list-selection",
            key: "interested_vehicles",
            required: false,
          }, {
            title: "Estado do Lead",
            type: "select",
            key: "state",
            required: true,
          }, {
            title: "Revisar Dados",
            type: "review",
          },
        ],
        troca: [
          ...commonSteps,
          ...tradeInCarSteps, {
            title: "Estado do Lead",
            type: "select",
            key: "state",
            required: true,
          }, {
            title: "Revisar Dados",
            type: "review",
          },
        ],
      };
      
      function getClientSteps() {
        if (clientType === "comum" && !clientPaymentType) {
          return clientSteps.comum;
        }
        if (clientType === "a_vista" || (clientType === "comum" && clientPaymentType === "a_vista")) {
          return clientSteps.a_vista;
        }
        if (clientType.startsWith("financiamento") || (clientType === "comum" && clientPaymentType === "financiamento")) {
          if (clientData.trade_in_car?.has_trade) {
            const newSteps = [
              ...clientSteps.financiamento.slice(0, 3),
              ...tradeInCarSteps,
              ...clientSteps.financiamento.slice(3)
            ];
            newSteps.forEach((step, index) => {
                const titleParts = step.title.split(': ');
                const newTitle = titleParts.length > 1 ? titleParts[1] : titleParts[0];
                step.title = `Etapa ${index + 1}: ${newTitle}`;
            });
            return newSteps;
          }
          return clientSteps.financiamento;
        }
        if (clientType === "visita") {
            return clientSteps.visita;
        }
        if (clientType === "troca") {
            return clientSteps.troca;
        }
        return [];
      }

      function updateClientStepContent() {
        const title = document.getElementById("client-step-title");
        const contentContainer = document.getElementById("form-content-area");
        const progressDotsContainer = document.querySelector("#client-register-card .progress-dots");
        const nextBtn = document.getElementById("client-next-btn");
        const prevBtn = document.getElementById("client-prev-btn");

        if (clientStep === 0) {
          title.textContent = "Etapa 1: Selecione o Tipo de Cliente";
          contentContainer.innerHTML = `
              <div class="client-type-buttons">
                  <button class="btn" onclick="startClientFlow('troca')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-ccw"><path d="M2.5 15.5V11a9 9 0 0 1 9-9h0a9 9 0 0 1 9 9v0" /><path d="M21.5 8.5V13a9 9 0 0 1-9 9h0a9 9 0 0 1-9-9v0" /></svg>
                      Troca
                  </button>
                  <button class="btn" onclick="startClientFlow('visita')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                      Visita
                  </button>
                  <button class="btn" onclick="startClientFlow('comum')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.08a2 2 0 0 0 2 1.92h9.44a2 2 0 0 0 2-1.68L23 5H6"></path></svg>
                      Venda
                  </button>
              </div>
          `;
          document.querySelector(".step-buttons").style.display = "none";
          document.querySelector(".progress-dots").style.display = "none";
          prevBtn.style.display = "none";
          return;
        }

        const steps = getClientSteps();
        if (clientStep > steps.length) {
            clientStep = steps.length;
        }
        const stepInfo = steps[clientStep - 1];
        title.textContent = stepInfo.title;
        let newContent = "";

        if (stepInfo.type === "input-group") {
            newContent = `<div class="input-group">${stepInfo.fields
                .map((field) => {
                    let currentValue = field.key.split(".").reduce((obj, key) => (obj && obj[key] !== undefined) ? obj[key] : '', clientData);
                    
                    if (field.key.includes('entry') || field.key.includes('value') || field.key.includes('price')) {
                        currentValue = toBRL(currentValue);
                    } else {
                        currentValue = currentValue || "";
                    }
                    
                    const readonlyAttribute = field.readonly ? "readonly" : "";
                    const placeholder = field.placeholder;
                    const inputId = `client-input-${field.key.replace(".", "-")}`;
                    const inputType = field.type === 'number' ? 'text' : field.type;
                    return `<input type="${inputType}" id="${inputId}" placeholder="${placeholder}" value="${currentValue}" ${
                        field.required ? "required" : ""
                    } ${field.inputmode ? `inputmode="${field.inputmode}"` : ""} ${readonlyAttribute}>`;
                })
                .join("")}</div>`;
        } else if (stepInfo.type === "select") {
          const options = kanbanColumns.map((col) => ({
            value: col.id,
            label: col.name,
          }));
          const currentValue = clientData.state;
          const optionsHtml = options
            .map(
              (opt) =>
              `<option value="${opt.value}" ${
                  opt.value === currentValue ? "selected" : ""
                }>${opt.label}</option>`
            )
            .join("");
          newContent = `<select id="client-input-state" ${
            stepInfo.required ? "required" : ""
          }>${optionsHtml}</select>`;
        } else if (stepInfo.type === "select-group") {
          const optionsHtml = stepInfo.options
            .map((opt) => `<option value="${opt.value}">${opt.label}</option>`)
            .join("");
          newContent = `<select id="client-input-${stepInfo.key.replace(
            ".",
            "-"
          )}" ${stepInfo.required ? "required" : ""}>${optionsHtml}</select>`;
        } else if (stepInfo.type === "photo-upload") {
          newContent = `<div style="display: flex; flex-direction: column; gap: 1rem;">
              <div class="photo-upload">
                  <p>${stepInfo.description || ''}</p>
                  <input type="file" id="${stepInfo.key}-input" accept="${stepInfo.accept}" multiple>
                  <label for="${stepInfo.key}-input">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                      Enviar Arquivos
                  </label>
                  <div class="photo-preview" id="${stepInfo.key}-preview"></div>
              </div>
          </div>`;
        } else if (stepInfo.type === "list-selection") {
          newContent = `<ul id="car-list-selection" class="car-interest-list"></ul>`;
        } else if (stepInfo.type === "review") {
            const interestedVehiclesNames = Array.isArray(clientData.interested_vehicles) ?
                clientData.interested_vehicles.map((v) => v.nome).join(", ") : "Nenhum";
            const formattedTradeIn = clientData.trade_in_car.model ?
                `<p><strong>Carro Troca:</strong> ${clientData.trade_in_car.model} (${clientData.trade_in_car.year || "N/A"})</p><p><strong>Valor de Troca:</strong> ${toBRL(clientData.trade_in_car.value)}</p>` : "";
            const formattedDocuments = clientData.documents && clientData.documents.length > 0
                ? `<p><strong>Documentos Enviados:</strong> ${clientData.documents.length} arquivo(s)</p>`: "";
            const formattedVisit = clientData.visit_details.day ?
                `<p><strong>Visita:</strong> ${new Date(clientData.visit_details.day).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} às ${clientData.visit_details.time || "N/A"}</p>` : "";
            const formattedPayment = clientData.payment_method ?
                `<p><strong>Método de Pagamento:</strong> ${dealTypeMap[clientData.payment_method.toLowerCase()] || clientData.payment_method}</p>` : "";
            const formattedFinancing = clientData.financing_details.entry ?
                `<h4>Detalhes do Financiamento</h4>
                  <p><strong>Entrada:</strong> ${toBRL(clientData.financing_details.entry)}</p>
                  <p><strong>Parcelas:</strong> ${clientData.financing_details.parcels}x</p>
                  <p><strong>Valor a Financiar:</strong> ${toBRL(clientData.financing_details.amount)}</p>` : "";

          newContent = `<div id="client-input" style="text-align: left;">
              <p><strong>Nome:</strong> ${clientData.name || "Não informado"}</p>
              <p><strong>Telefone:</strong> ${clientData.phone || "Não informado"}</p>
              <p><strong>CPF:</strong> ${clientData.cpf || "Não informado"}</p>
              <p><strong>Ocupação:</strong> ${clientData.job || "Não informado"}</p>
              <p><strong>Veículos de Interesse:</strong> ${interestedVehiclesNames || "Nenhum"}</p>
              ${formattedTradeIn}
              ${formattedDocuments}
              ${formattedVisit}
              ${formattedPayment}
              ${formattedFinancing}
              <p><strong>Estado:</strong> ${
                kanbanColumns.find((col) => col.id === clientData.state)?.name ||
                "Novo Lead"
              }</p>
          </div>`;
        } else if (stepInfo.type === "payment-type") {
          newContent = `
              <div class="payment-type-buttons">
                  <button class="btn" onclick="selectPaymentType('a_vista')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                      À Vista
                  </button>
                  <button class="btn" onclick="selectPaymentType('financiamento')">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-credit-card"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                      Financiamento
                  </button>
              </div>
          `;
        } else if (stepInfo.type === "trade-in-car-option") {
          newContent = `
              <div id="trade-in-options" style="display: flex; flex-direction: column; gap: 1rem;">
                  <button class="btn" onclick="handleTradeInOption(true)">Sim</button>
                  <button class="btn secondary" onclick="handleTradeInOption(false)">Não</button>
              </div>
          `;
        }

        contentContainer.innerHTML = newContent;
        
        if (stepInfo.type === "input-group") {
          stepInfo.fields.forEach((field) => {
            const inputElement = document.getElementById(`client-input-${field.key.replace(".", "-")}`);
            if (inputElement) {
              if (field.type === "tel") {
                inputElement.addEventListener("input", (e) => formatPhone(e.target));
              }
              if (field.key.includes('entry') || field.key.includes('value') || field.key.includes('price')) {
                inputElement.addEventListener("input", (e) => {
                  formatCurrencyInput(e.target);
                  updateFinancingAmount();
                });
              }
            }
          });
          if (document.getElementById("client-input-financing_details-amount")) {
              updateFinancingAmount();
          }
        } else if (stepInfo.type === "photo-upload") {
          document
            .getElementById(`${stepInfo.key}-input`)
            .addEventListener("change", (e) => handleClientFileSelect(e, stepInfo.key));
          updateClientDocumentPreview(key);
        } else if (stepInfo.type === "list-selection") {
          renderCarSelectionList();
          nextBtn.disabled = !Array.isArray(clientData.interested_vehicles) || clientData.interested_vehicles.length === 0;
        }

        if (stepInfo.type === "payment-type" || clientStep === 0 || stepInfo.type === "trade-in-car-option") {
          nextBtn.style.display = "none";
        } else {
          nextBtn.style.display = "inline-flex";
        }

        prevBtn.style.display = clientStep > 0 ? "inline-flex" : "none";

        if (clientStep === steps.length) {
          nextBtn.innerHTML = "Finalizar";
          nextBtn.onclick = saveClient;
        } else {
          nextBtn.innerHTML = `Próximo <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>`;
          nextBtn.onclick = nextClientStep;
        }

        updateClientProgressDots();
      }

      async function renderCarSelectionList() {
        if (availableCars.length === 0) {
          await loadCars();
        }
        const list = document.getElementById("car-list-selection");
        list.innerHTML = "";
        availableCars.forEach((car) => {
          const isSelected = clientData.interested_vehicles.some((c) => c.id === car.id);
          const li = document.createElement("li");
          li.id = `car-${car.id}`;
          li.className = isSelected ? "selected" : "";
          li.onclick = () => toggleCarSelection(car.id);
          li.innerHTML = `
              <img src="http://localhost:5000/${car.imagens[0]}" alt="${car.nome}" onerror="this.src='https://via.placeholder.com/60?text=Sem+Foto'">
              <div class="car-info">
                  <strong>${car.nome}</strong><br>
                  <small>${toBRL(car.preco)}</small>
              </div>
          `;
          list.appendChild(li);
        });
        document.getElementById("client-next-btn").disabled =
          !Array.isArray(clientData.interested_vehicles) ||
          clientData.interested_vehicles.length === 0;
      }

      function handleClientFileSelect(event, key) {
        clientData[key] = [...(clientData[key] || []), ...Array.from(event.target.files)];
        updateClientDocumentPreview(key);
      }

      function updateClientDocumentPreview(key) {
        const previewContainer = document.getElementById(`${key}-preview`);
        if (!previewContainer) return;
        previewContainer.innerHTML = "";
        (clientData[key] || []).forEach((file, index) => {
          const container = document.createElement("div");
          container.style.position = "relative";
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style =
            "max-width: 80px; max-height: 80px; object-fit: cover; border-radius: 0.75rem;";
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-photo";
          removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
          removeBtn.onclick = () => {
            clientData[key].splice(index, 1);
            updateClientDocumentPreview(key);
          };
          container.append(img, removeBtn);
          previewContainer.appendChild(container);
        });
      }

      function updateClientProgressDots() {
        const progressDotsContainer = document.querySelector("#client-register-card .progress-dots");
        progressDotsContainer.innerHTML = "";
        const steps = getClientSteps();
        const totalSteps = steps.length;

        for (let i = 0; i < totalSteps; i++) {
          const dot = document.createElement("div");
          dot.className = `progress-dot ${i < clientStep ? "active" : ""}`;
          progressDotsContainer.appendChild(dot);
        }
      }
      
      window.onload = () => {
        document.getElementById("hamburger-menu").addEventListener("click", toggleSidebar);
        document.getElementById("overlay").addEventListener("click", toggleSidebar);
        document.getElementById("client-search").addEventListener("input", (e) => {
          filterClients(e.target.value);
        });

        window.addEventListener('resize', () => {
            if (document.getElementById('crm')?.classList.contains('active')) {
                goToPage(currentPage);
            }
        });

        showTab("dashboard");
      };

      function showTab(tabId) {
        document.querySelectorAll(".tab-content").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".nav a").forEach((a) => a.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");

        const link = document.querySelector(`.nav a[onclick*="'${tabId}'"]`);
        if (link) link.classList.add("active");

        if (checkStatusInterval) clearInterval(checkStatusInterval);
        if (pollClientsInterval) clearInterval(pollClientsInterval);

        if (tabId === "dashboard") {
          loadKanbanStates();
          loadClients();
        }
        if (tabId === "catalog") {
          loadCars();
        }
        if (tabId === "crm") {
          currentPage = 1;
          loadKanbanStates().then(() => {
            loadClients().then(() => {
              if (pollClientsInterval) clearInterval(pollClientsInterval);
              pollClientsInterval = setInterval(pollClients, 5000);
            });
          });
        }
        if (tabId === "add-car") {
          resetCarForm();
        }
        if (tabId === "client-register") {
          resetClientForm();
          loadCars();
        }
        if (tabId === "qrcode") {
          checkConnectionStatus();
          checkStatusInterval = setInterval(checkConnectionStatus, 5000);
        }

        if (
          window.innerWidth <= 1024 &&
          document.getElementById("sidebar").classList.contains("active")
        ) {
          toggleSidebar();
        }
      }

      function nextStep() {
        const input = document.getElementById("car-input");
        if (currentStep < 5 && input && !input.value.trim()) {
          input.style.borderColor = "#EF4444";
          return;
        }
        if (input) input.style.borderColor = "#E5E7EB";
        if (currentStep === 1) carData.name = input.value;
        else if (currentStep === 2) carData.year = input.value;
        else if (currentStep === 3) carData.price = parseCurrency(input.value);
        else if (currentStep === 4) carData.description = input.value;
        else if (currentStep === 5 && carData.files.length === 0) {
          showCustomAlert("Atenção", "Por favor, selecione pelo menos uma foto.");
          return;
        }
        currentStep++;
        updateStepContent();
      }

      function prevStep() {
        if (currentStep > 1) {
          currentStep--;
          updateStepContent();
        }
      }

      function updateStepContent() {
        const card = document.getElementById("add-car-card");
        const title = document.getElementById("step-title");
        let contentContainer = card.querySelector(
          "input, textarea, .photo-upload, div[style*='text-align: left;']"
        );

        const steps = [{
          title: "Etapa 1: Nome do Veículo",
          type: "text",
          placeholder: "Digite o nome do veículo",
          key: "name",
        }, {
          title: "Etapa 2: Ano do Veículo",
          type: "text",
          placeholder: "Digite o ano",
          key: "year",
        }, {
          title: "Etapa 3: Valor",
          type: "text",
          placeholder: "Digite o valor",
          key: "price",
          inputmode: "decimal"
        }, {
          title: "Etapa 4: Descrição",
          type: "textarea",
          placeholder: "Digite a descrição do veículo",
          key: "description",
        }, {
          title: "Etapa 5: Fotos",
          type: "photo-upload",
          accept: "image/*",
          key: "files",
        }, {
          title: "Etapa 6: Finalizar Cadastro",
          type: "review",
        }, ];

        const stepInfo = steps[currentStep - 1];
        title.textContent = stepInfo.title;
        let newContent = "";

        if (stepInfo.type === "textarea") {
          newContent = `<textarea id="car-input" placeholder="${stepInfo.placeholder}" rows="4" required>${carData.description || ""}</textarea>`;
        } else if (stepInfo.type === "photo-upload") {
          newContent = `<div class="photo-upload" id="car-input">
                                  <input type="file" id="file-input" accept="${stepInfo.accept}" multiple>
                                  <label for="file-input">
                                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.5l2-2.92-1.5-1.5-1-1zm6-1.5l-3-4-5 6z"/></svg>
                                      Escolher Fotos
                                  </label>
                                  <div class="photo-preview" id="photo-preview"></div>
                                  <div class="add-more-photo" onclick="document.getElementById('file-input').click()">
                                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                  </div>
                                </div>`;
        } else if (stepInfo.type === "review") {
          newContent = `<div style="text-align: left;">
                                  <p><strong>Nome:</strong> ${carData.name || "Não informado"}</p>
                                  <p><strong>Ano:</strong> ${carData.year || "Não informado"}</p>
                                  <p><strong>Valor:</strong> ${toBRL(carData.price)}</p>
                                  <p><strong>Descrição:</strong> ${carData.description || "Sem descrição"}</p>
                                  <p><strong>Fotos:</strong> ${carData.files.length} foto(s)</p>
                                </div>`;
        } else {
            const value = carData[stepInfo.key] || '';
            const formattedValue = (stepInfo.key === 'price') ? toBRL(value).replace('Não informado', '') : value;
            newContent = `<input type="${stepInfo.type}" id="car-input" placeholder="${stepInfo.placeholder}" value="${formattedValue}" required ${stepInfo.inputmode ? `inputmode="${stepInfo.inputmode}"` : ''}>`;
        }

        contentContainer.outerHTML = newContent;
        const newInput = document.getElementById('car-input');

        if (stepInfo.key === 'price') {
            newInput.addEventListener('input', (e) => formatCurrencyInput(e.target));
        }
        if(stepInfo.key === 'year') {
            newInput.maxLength = 4;
            newInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/\D/g, ''); });
        }
        if (stepInfo.type === "photo-upload") {
          document.getElementById("file-input").addEventListener("change", handleFileSelect);
          updatePhotoPreview();
        }

        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const stepButtons = card.querySelector(".step-buttons");

        prevBtn.style.display = currentStep > 1 ? "inline-block" : "none";
        if (stepInfo.type === "review") {
          nextBtn.textContent = "Finalizar";
          nextBtn.onclick = submitCar;
          if (!document.getElementById("new-car-btn")) {
            const newCarBtn = document.createElement("button");
            newCarBtn.id = "new-car-btn";
            newCarBtn.className = "btn";
            newCarBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm4 9.17h-3.17v3.17H11.83V13.17H8.66v-2.34h3.17V7.66h2.34v3.17h3.17v2.34z"/></svg>Salvar e Novo`;
            newCarBtn.onclick = addNewCar;
            stepButtons.appendChild(newCarBtn);
          }
        } else {
          nextBtn.innerHTML = `Próximo <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>`;
          nextBtn.onclick = nextStep;
          const newCarBtn = document.getElementById("new-car-btn");
          if (newCarBtn) newCarBtn.remove();
        }
        updateProgressDots();
      }

      async function saveCar() {
        const formData = new FormData();
        formData.append("name", carData.name || "");
        formData.append("year", carData.year || "");
        formData.append("price", carData.price || "");
        formData.append("description", carData.description || "");
        carData.files.forEach((file) => formData.append("images", file));

        const response = await fetch("http://localhost:5000/api/cars", {
          method: "POST",
          body: formData,
        });
        if (!response.ok)
          throw new Error(`Erro ao cadastrar carro: ${await response.text()}`);
        return await response.json();
      }

      function resetCarForm() {
        currentStep = 1;
        carData = {
          files: [],
        };
        updateStepContent();
      }

      async function submitCar() {
        try {
          await saveCar();
          await loadCars();
          showTab("catalog");
        } catch (error) {
          console.error("Erro ao salvar carro:", error);
          showCustomAlert("Erro", `Erro ao cadastrar o veículo: ${error.message}.`);
        }
      }

      async function addNewCar() {
        try {
          await saveCar();
          await loadCars();
          resetCarForm();
        } catch (error) {
          console.error("Erro ao salvar e adicionar novo carro:", error);
          showCustomAlert("Erro", `Erro ao cadastrar o veículo: ${error.message}.`);
        }
      }

      function renderCars() {
        const container = document.getElementById("car-list");
        container.innerHTML = "";
        if (!cars.modelos || cars.modelos.length === 0) {
          container.innerHTML = '<p style="text-align: center;">Nenhum veículo disponível.</p>';
          return;
        }
        cars.modelos.forEach((car, index) => {
          const carId = car.id || (index + 1).toString();
          const card = document.createElement("div");
          card.className = "vehicle-card";
          let imageSrc =
            car.imagens && car.imagens.length > 0 ?
            `http://localhost:5000/${car.imagens[0]}` :
            "https://via.placeholder.com/350x280?text=Sem+Imagem";
          card.innerHTML = `
              <div class="vehicle-card-image"><img src="${imageSrc}" alt="${car.nome}" onload="this.style.opacity='1'" onerror="this.src='https://via.placeholder.com/350x280?text=Erro'"></div>
              <div class="vehicle-card-content">
                  <h3>${car.nome || "Sem nome"}</h3>
                  <p>${toBRL(car.preco)}</p>
              </div>
              <div class="card-buttons">
                  <button class="details-button" onclick="showCarDetails('${carId}')">
                      Detalhes
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M.046 8.5c.66 1.838 2.373 3.5 4.954 3.5 2.58 0 4.293-1.662 4.954-3.5H.046zM12 12c-2.58 0-4.293-1.662-4.954-3.5h9.908c-.66 1.838-2.373 3.5-4.954 3.5zM12 4a3.5 3.5 0 0 0-3.5 3.5c0 1.933 1.567 3.5 3.5 3.5s3.5-1.567 3.5-3.5S13.933 4 12 4z"/></svg>
                  </button>
              </div>
              <button class="delete-btn" onclick="openDeleteDialog('${carId}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
              </button>`;
          container.appendChild(card);
        });
      }

      function openDeleteDialog(carId) {
        carToDelete = carId;
        document.getElementById("delete-dialog").style.display = "block";
      }
      async function confirmDelete() {
        try {
          const response = await fetch(
            `http://localhost:5000/api/cars/${carToDelete}`, {
              method: "DELETE",
            }
          );
          if (!response.ok)
            throw new Error(`Erro ao deletar veículo: ${await response.text()}`);
          await loadCars();
          closeDeleteDialog();
        } catch (error) {
          console.error("Erro ao deletar veículo:", error);
          showCustomAlert("Erro", `Erro ao deletar o veículo: ${error.message}.`);
        }
      }

      function closeDeleteDialog() {
        document.getElementById("delete-dialog").style.display = "none";
        carToDelete = null;
      }

      function closeDialog() {
        document.getElementById("client-dialog").style.display = "none";
      }

      function handleFileSelect(event) {
        carData.files = [...carData.files, ...Array.from(event.target.files)];
        updatePhotoPreview();
      }

      function updatePhotoPreview() {
        const preview = document.getElementById("photo-preview");
        if (!preview) return;
        preview.innerHTML = "";
        carData.files.forEach((file, index) => {
          const container = document.createElement("div");
          container.style.position = "relative";
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.style =
            "max-width: 80px; max-height: 80px; object-fit: cover; border-radius: 6px;";
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-photo";
          removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
          removeBtn.onclick = () => {
            carData.files.splice(index, 1);
            updatePhotoPreview();
          };
          container.append(img, removeBtn);
          preview.appendChild(container);
        });
      }

      function updateProgressDots() {
        const dots = document.querySelectorAll("#add-car-card .progress-dot");
        dots.forEach((dot, index) => dot.classList.toggle("active", index < currentStep));
      }

      function refreshQR() {
        const qrCodeImg = document.getElementById("qrcode-img");
        const noQrMsg = document.getElementById("no-qrcode-msg");
        const statusElement = document.getElementById("connection-status");

        const newQrUrl = `http://localhost:5000/QRCODE/qrcode.png?t=${Date.now()}`;

        qrCodeImg.src = newQrUrl;
        qrCodeImg.onload = () => {
          qrCodeImg.style.display = "block";
          noQrMsg.style.display = "none";
        };
        qrCodeImg.onerror = () => {
          qrCodeImg.style.display = "none";
          noQrMsg.style.display = "block";
          statusElement.textContent = "QR Code não disponível.";
          statusElement.style.color = "#EF4444";
        };

        statusElement.textContent = "Aguardando conexão...";
        statusElement.style.color = "var(--cor-texto-secundario)";

        if (checkStatusInterval) clearInterval(checkStatusInterval);
        checkStatusInterval = setInterval(checkConnectionStatus, 5000);
      }

      async function checkConnectionStatus() {
        try {
          const response = await fetch("http://localhost:5000/status");
          if (!response.ok)
            throw new Error(`Erro ao verificar status: ${await response.text()}`);
          const data = await response.json();
          const statusElement = document.getElementById("connection-status");
          const qrCodeImg = document.getElementById("qrcode-img");
          const noQrMsg = document.getElementById("no-qrcode-msg");

          if (data.isReady) {
            statusElement.textContent = "Conectado ao WhatsApp!";
            statusElement.style.color = "#22C55E";
            qrCodeImg.style.display = "none";
            noQrMsg.style.display = "none";
            clearInterval(checkStatusInterval);
          } else {
            statusElement.textContent = "Aguardando escaneamento...";
            statusElement.style.color = "var(--cor-texto-secundario)";
            refreshQR();
          }
        } catch (error) {
          console.error("Erro ao verificar status:", error);
          document.getElementById("connection-status").textContent = `Erro de conexão com o servidor.`;
          document.getElementById("connection-status").style.color = "#EF4444";
        }
      }

      async function updateCrmDashboard(clients) {
        try {
          document.getElementById("total-clients").textContent = clients.length;
          document.getElementById("total-sales").textContent = clients.filter(
            (c) => c.bot_data?.state === "finalizado"
          ).length;
          document.getElementById("lost-leads").textContent = clients.filter(
            (c) => c.bot_data?.state === "perdido"
          ).length;

          let totalDuration = 0;
          let clientsWithHistory = 0;
          clients.forEach((client) => {
            if (client.bot_data?.history && client.bot_data.history.length > 1) {
              try {
                const firstMessageTime = client.bot_data.history[0].timestamp;
                const firstResponseTime = client.bot_data.history[1].timestamp;

                const parseDate = (str) => {
                  const [date, time] = str.split(", ");
                  const [day, month, year] = date.split("/");
                  return new Date(`${year}-${month}-${day}T${time}`);
                };

                const start = parseDate(firstMessageTime);
                const end = parseDate(firstResponseTime);

                const durationInSeconds = (end.getTime() - start.getTime()) / 1000;
                if (durationInSeconds > 0) {
                  totalDuration += durationInSeconds;
                  clientsWithHistory++;
                }
              } catch (e) {
                console.error("Erro ao parsear data do histórico:", e);
              }
            }
          });

          const averageResponseTimeInSeconds =
            clientsWithHistory > 0 ?
            Math.round(totalDuration / clientsWithHistory) :
            0;
          
          document.getElementById("average-response-time").textContent = formatDuration(averageResponseTimeInSeconds);

          const statusCount = clients.reduce((acc, client) => {
              const columnId = getClientColumnId(client.bot_data?.state);
              const columnName = kanbanColumns.find(col => col.id === columnId)?.name || "Outros";
              acc[columnName] = (acc[columnName] || 0) + 1;
              return acc;
          }, {});

          const paymentMethodCount = clients.reduce((acc, client) => {
            let rawMethod = client.payment_method || client.bot_data?.payment_method;
            let finalMethod;

            if (rawMethod) {
                const lowerMethod = String(rawMethod).toLowerCase();
                if (lowerMethod.includes('financiamento')) {
                    finalMethod = "Financiamento";
                } else if (lowerMethod.includes('vista')) {
                    finalMethod = "À Vista";
                } else {
                    finalMethod = "Não Informado";
                }
            } else {
                finalMethod = "Não Informado";
            }
            
            acc[finalMethod] = (acc[finalMethod] || 0) + 1;
            return acc;
          }, {});

          renderStatusDoughnutChart(statusCount);
          renderPaymentBarChart(paymentMethodCount);
        } catch (error) {
          console.error("Erro ao atualizar o dashboard do CRM:", error);
        }
      }

      let statusDoughnutChart, paymentBarChart;

      function renderStatusDoughnutChart(data) {
        const ctx = document.getElementById("statusDoughnutChart").getContext("2d");
        if (statusDoughnutChart) statusDoughnutChart.destroy();

        const total = Object.values(data).reduce((acc, value) => acc + value, 0);
        const colors = ["#00C6FF", "#3CFF28", "#EBEF17", "#F26721", "#C22F9F", "#A55B2E", "#6A3E9E", "#FF5733", "#33FF57"];

        statusDoughnutChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: Object.keys(data),
            datasets: [{
              data: Object.values(data),
              backgroundColor: colors,
              hoverOffset: 10,
              borderWidth: 0,
            }, ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "80%",
            plugins: {
              legend: {
                display: false,
              },
            },
          },
          plugins: [{
            id: "centerText",
            beforeDraw: (chart) => {
              const {
                width,
                height,
                ctx
              } = chart;
              ctx.restore();
              ctx.font = `bolder ${(height / 110).toFixed(2)}em Poppins`;
              ctx.textBaseline = "middle";
              ctx.fillStyle = "#E2E8F0";
              ctx.fillText(
                total,
                Math.round((width - ctx.measureText(total).width) / 2),
                height / 2 - 10
              );
              ctx.font = `${(height / 220).toFixed(2)}em Poppins`;
              ctx.fillStyle = "var(--cor-texto-secundario)";
              ctx.fillText(
                "Clientes",
                Math.round((width - ctx.measureText("Clientes").width) / 2),
                height / 2 + 15
              );
              ctx.save();
            },
          }, ],
        });

        const legendList = document.getElementById("status-legend-list");
        legendList.innerHTML = "";
        Object.entries(data).forEach(([key, value], index) => {
          const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
          const listItem = document.createElement("li");
          listItem.innerHTML = `
              <div class="legend-label">
                  <span class="legend-color-box" style="background-color: ${
                    colors[index % colors.length]
                  };"></span>
                  <span style="color: var(--cor-texto-principal);">${key}</span>
              </div>
              <span class="legend-value">${value} (${percentage}%)</span>`;
          legendList.appendChild(listItem);
        });
      }

      function renderPaymentBarChart(data) {
        const ctx = document.getElementById("paymentBarChart").getContext("2d");
        if (paymentBarChart) paymentBarChart.destroy();
        const backgroundColors = [
          "#00C6FF",
          "#00B8E3",
          "#00A9CC",
          "#009BB5",
          "#008DAE",
          "#007FA7",
          "#0071A0",
        ];
        paymentBarChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: Object.keys(data),
            datasets: [{
              label: "Número de Clientes",
              data: Object.values(data),
              backgroundColor: Object.keys(data).map(
                (_, index) => backgroundColors[index % backgroundColors.length]
              ),
              borderColor: "rgba(255, 255, 255, 0.1)",
              borderWidth: 1,
              borderRadius: 5,
              borderSkipped: false,
            }, ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: "#E2E8F0",
                  font: {
                    weight: 'bold'
                  }
                },
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
              },
              x: {
                ticks: {
                  color: "#E2E8F0",
                  font: {
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false,
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>