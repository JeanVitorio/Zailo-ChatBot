<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZailonSoft - Detalhes do Cliente</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --cor-fundo-escuro: #060918;
            --cor-fundo-card: #0F1326;
            --cor-borda: #1D233F;
            --cor-destaque: #00F5FF;
            --cor-destaque-hover: #00D5E0;
            --cor-texto-principal: #E2E8F0;
            --cor-texto-secundario: #94A3B8;
            --cor-success: #22C55E;
            --cor-danger: #EF4444;
            --cor-gradiente-principal: linear-gradient(145deg, #060918 0%, #0C122D 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--cor-gradiente-principal);
            color: var(--cor-texto-principal);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        .btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; 
            background-color: var(--cor-destaque); color: var(--cor-fundo-escuro); 
            padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; text-transform: uppercase; 
            box-shadow: 0 4px 10px rgba(0, 245, 255, 0.3); text-decoration: none; 
        }
        .btn:hover { background-color: var(--cor-destaque-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 245, 255, 0.4); }
        .btn--secondary { background-color: transparent; color: var(--cor-destaque); border: 2px solid var(--cor-destaque); box-shadow: none; }
        .btn--secondary:hover { background-color: var(--cor-destaque); color: var(--cor-fundo-escuro); }
        .btn--danger { background-color: transparent; color: var(--cor-danger); border: 2px solid var(--cor-danger); box-shadow: none; }
        .btn--danger:hover { background-color: var(--cor-danger); color: var(--cor-texto-principal); }

        .card { 
            background-color: var(--cor-fundo-card); border: 1px solid var(--cor-borda); 
            border-radius: 1.5rem; padding: 2.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); 
            display: flex; flex-direction: column; gap: 1.5rem; 
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid var(--cor-borda); }
        .card-header h2 { font-size: 1.5rem; font-weight: 600; }
        .card-content { display: flex; flex-direction: column; gap: 1rem; }

        input[type="text"], input[type="tel"], input[type="file"], select, textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--cor-borda); 
            border-radius: 0.5rem; background: var(--cor-fundo-escuro); font-family: 'Poppins', sans-serif; 
            font-size: 1rem; color: var(--cor-texto-principal); transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--cor-destaque); box-shadow: 0 0 10px rgba(0, 245, 255, 0.4); outline: none; 
        }
        textarea { resize: vertical; min-height: 120px; }

        body { padding: 2.5rem; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 2rem; }
        
        /* --- MUDANÇAS NO HEADER --- */
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header h1 { font-size: 2rem; font-weight: 700; margin-right: auto; }
        .header-actions { display: flex; gap: 1rem; }
        
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 992px) {
            .main-grid { grid-template-columns: 2fr 1fr; align-items: start; }
            .right-section, .left-section { display: flex; flex-direction: column; gap: 2rem; }
        }

        body:not(.editing) .edit-field { display: none !important; }
        body.editing .display-field { display: none !important; }
        
        /* --- NOVAS REGRAS PARA OS BOTÕES --- */
        body:not(.editing) .save-btn, body:not(.editing) .cancel-btn, body:not(.editing) .delete-btn { display: none !important; }
        body.editing .edit-btn, body.editing .back-btn { display: none !important; }

        .info-group { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 0; border-bottom: 1px solid var(--cor-borda); }
        .info-group:last-child { border-bottom: none; }
        .info-group label { font-weight: 500; color: var(--cor-texto-secundario); flex-shrink: 0; min-width: 150px; }
        .info-group .display-field, .info-group .edit-field { text-align: right; flex-grow: 1; word-break: break-word; }

        .info-group-highlight { margin-top: 0.5rem; padding: 1rem; background: rgba(0,245,255,0.05); border-radius: .5rem; border-left: 3px solid var(--cor-destaque); text-align: right; font-weight: 600; }
        .info-group-highlight strong { color: var(--cor-destaque); }

        .status-display { font-weight: 600; padding: 0.4rem 1rem; border-radius: 50px; font-size: 0.8rem; text-transform: uppercase; }

        .interest-search-wrapper { position: relative; }
        .interest-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
        .interest-pill { display: flex; align-items: center; gap: 0.5rem; background: var(--cor-borda); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.9rem; }
        .interest-pill button { background: none; border: none; color: var(--cor-texto-secundario); cursor: pointer; font-size: 1rem; line-height: 1; padding-left: 0.5rem;}
        .interest-pill button:hover { color: var(--cor-danger); }
        .interest-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--cor-fundo-card); border: 1px solid var(--cor-destaque); border-radius: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 100; margin-top: 0.25rem; }
        .interest-results div { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s; }
        .interest-results div:hover { background-color: rgba(0, 245, 255, 0.1); }

        .upload-section { margin-top: 1rem; }
        .section-label { font-weight: 500; color: var(--cor-texto-secundario); display: block; margin-bottom: 1rem; }
        .documents-grid { display: flex; flex-wrap: wrap; gap: 1rem; }
        .doc-wrapper { position: relative; }
        .doc-wrapper img { width: 100px; height: 100px; object-fit: cover; border-radius: 0.75rem; border: 1px solid var(--cor-borda); transition: all 0.3s ease; cursor: pointer; }
        .doc-wrapper img:hover { transform: scale(1.05); border-color: var(--cor-destaque); }
        .doc-remove-btn { position: absolute; top: -5px; right: -5px; background: var(--cor-danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2;}
        .file-input { display: none; }
        .btn-upload { background: var(--cor-borda); color: var(--cor-texto-principal); border: 1px dashed var(--cor-destaque); text-align: center; display: block; margin-top: 1rem; cursor: pointer; }
        .btn-upload:hover { background: rgba(0,245,255,0.1); }
        
        .conditional-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--cor-borda); }

        .history-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .history-item { display: flex; justify-content: space-between; flex-wrap: wrap; font-size: 0.9em; border-left: 3px solid var(--cor-destaque); padding: 0.75rem 1rem; background-color: rgba(0, 245, 255, 0.05); border-radius: 0.5rem; }
        .history-item .timestamp { color: var(--cor-texto-secundario); font-size: 0.8em; }

        /* A classe .actions no final da página não é mais necessária */
        .actions { display: none; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6, 9, 24, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal:not(.hidden) { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--cor-fundo-card); border: 1px solid var(--cor-borda); border-radius: 1.5rem; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; gap: 1.5rem; }
        #image-modal .modal-content { padding: 1rem; background: transparent; border: none; max-width: 90vw; max-height: 90vh; }
        #modal-image { max-width: 100%; max-height: 100%; object-fit: contain; cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="header">
            <h1 id="client-name-title">Carregando Detalhes...</h1>

            <div class="header-actions">
                <a href="index.html" class="btn btn--secondary back-btn"><i class="fas fa-arrow-left"></i> Voltar</a>
                <button class="btn edit-btn"><i class="fas fa-edit"></i> Editar Cliente</button>
                
                <button class="btn save-btn"><i class="fas fa-save"></i> Salvar</button>
                <button class="btn btn--secondary cancel-btn"><i class="fas fa-times"></i> Cancelar</button>
                <button class="btn btn--danger delete-btn"><i class="fas fa-trash"></i> Excluir</button>
            </div>
        </div>

        <div class="main-grid">
            <div class="left-section">
                <div class="card" id="profile-card">
                    <div class="card-header">
                        <h2>Perfil do Cliente</h2>
                        <div class="status-wrapper">
                            <span id="client-status-detail" class="status-display"></span>
                            <select id="client-status-edit" class="edit-field"></select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="info-group"> <label>Nome:</label> <span id="client-name-detail" class="display-field"></span> <input type="text" id="client-name-edit" class="edit-field"> </div>
                        <div class="info-group"> <label>Telefone:</label> <span id="client-phone-detail" class="display-field"></span> <input type="tel" id="client-phone-edit" class="edit-field"> </div>
                        <div class="info-group"> <label>CPF:</label> <span id="client-cpf-detail" class="display-field"></span> <input type="text" id="client-cpf-edit" class="edit-field"> </div>
                        <div class="info-group"> <label>Ocupação:</label> <span id="client-job-detail" class="display-field"></span> <input type="text" id="client-job-edit" class="edit-field"> </div>
                        <div class="info-group"> <label>Tipo de Negociação:</label> <span id="client-deal-type-detail" class="display-field"></span>
                            <select id="client-deal-type-edit" class="edit-field">
                                <option value="a_vista">À Vista</option>
                                <option value="financiamento">Financiamento</option>
                                <option value="troca">Troca</option>
                                <option value="visita">Visita</option>
                                <option value="comum">Venda</option>
                            </select>
                        </div>
                        <div class="info-group"> <label>ID do Chat:</label> <span id="client-chat-id-detail" class="display-field"></span> </div>
                    </div>
                </div>

                <div class="card" id="interest-card">
                    <div class="card-header">
                        <h2>Veículos de Interesse</h2>
                    </div>
                    <div class="card-content">
                        <div id="interest-pills-display" class="interest-pills display-field"></div>
                        <div class="interest-search-wrapper edit-field">
                            <input type="text" id="interest-search" class="edit-field" placeholder="Pesquisar por nome do veículo...">
                            <div id="interest-results" class="interest-results hidden"></div>
                            <div id="interest-pills-edit" class="interest-pills"></div>
                        </div>
                    </div>
                </div>

                <div class="card hidden" id="financing-card">
                    <div class="card-header">
                        <h2>Detalhes de Financiamento</h2>
                    </div>
                    <div class="card-content">
                        <div class="info-group">
                            <label>Valor da Entrada:</label>
                            <span id="financing-entry-detail" class="display-field"></span>
                            <input type="text" id="financing-entry-edit" class="edit-field" placeholder="R$ 0,00">
                        </div>
                        <div class="info-group">
                            <label>Parcelas:</label>
                            <span id="financing-installments-detail" class="display-field"></span>
                            <select id="financing-installments-edit" class="edit-field">
                                <option value="12">12x</option> <option value="24">24x</option>
                                <option value="36">36x</option> <option value="48">48x</option>
                                <option value="60">60x</option>
                            </select>
                        </div>
                        <div id="financing-amount-container"></div>
                    </div>
                </div>

                <div class="card hidden" id="trade-in-card">
                    <div class="card-header">
                        <h2>Carro para Troca</h2>
                    </div>
                    <div class="card-content">
                        <div class="info-group"> <label>Modelo:</label> <span id="trade-in-model-detail" class="display-field"></span> <input type="text" id="trade-in-model-edit" class="edit-field" placeholder="Ex: Fiat Uno"> </div>
                        <div class="info-group"> <label>Ano:</label> <span id="trade-in-year-detail" class="display-field"></span> <input type="text" id="trade-in-year-edit" class="edit-field" placeholder="Ex: 2015"> </div>
                        <div class="info-group"> <label>Valor Desejado:</label> <span id="trade-in-value-detail" class="display-field"></span> <input type="text" id="trade-in-value-edit" class="edit-field" placeholder="R$ 0,00"> </div>
                        
                        <div class="upload-section">
                            <label class="section-label">Fotos do Veículo:</label>
                            <div class="documents-grid display-field" id="trade-in-photos-grid-display"></div>
                            <div class="edit-field">
                                <div class="documents-grid" id="trade-in-photos-grid-edit"></div>
                                <input type="file" id="add-trade-in-photos-input" class="file-input" multiple accept="image/*">
                                <label for="add-trade-in-photos-input" class="btn btn-upload"><i class="fas fa-camera"></i> Adicionar Fotos</label>
                            </div>
                        </div>

                        <div class="conditional-section hidden" id="trade-in-difference-section">
                             <div id="trade-in-difference-value"></div>
                             <div class="info-group">
                                 <label>Pagar diferença:</label>
                                 <span id="trade-in-payment-option-detail" class="display-field"></span>
                                 <select id="trade-in-payment-option-edit" class="edit-field">
                                     <option value="a_vista">À Vista</option>
                                     <option value="financiamento">Financiamento</option>
                                 </select>
                             </div>
                             <div class="info-group hidden" id="trade-in-installments-section">
                                 <label>Parcelas (Diferença):</label>
                                 <span id="trade-in-installments-detail" class="display-field"></span>
                                 <select id="trade-in-installments-edit" class="edit-field">
                                     <option value="12">12x</option> <option value="24">24x</option>
                                     <option value="36">36x</option> <option value="48">48x</option>
                                     <option value="60">60x</option>
                                 </select>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <div class="card" id="history-card">
                    <div class="card-header">
                        <h2>Histórico de Interações</h2>
                    </div>
                    <div class="card-content">
                        <div class="history-list" id="client-history"></div>
                    </div>
                </div>

                <div class="card" id="documents-card">
                    <div class="card-header">
                        <h2>Documentos (RG, CPF, etc)</h2>
                    </div>
                    <div class="card-content">
                        <div class="upload-section">
                            <div class="documents-grid display-field" id="documents-grid-display"></div>
                            <div class="edit-field">
                               <div class="documents-grid" id="documents-grid-edit"></div>
                               <input type="file" id="add-docs-input" class="file-input" multiple accept="image/*,application/pdf">
                               <label for="add-docs-input" class="btn btn-upload"><i class="fas fa-file-upload"></i> Adicionar Documentos</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card notes">
                    <div class="card-header">
                        <h2>Anotações do CRM</h2>
                    </div>
                    <textarea id="crm-notes-display" readonly style="background:transparent; border:none; padding:0;"></textarea>
                    <textarea id="crm-notes-edit" class="edit-field" placeholder="Adicione notas sobre o cliente aqui..."></textarea>
                </div>
            </div>
        </div>
        
        </div>
    
    <div class="modal hidden" id="custom-modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-title">Notificação</h2> </div>
            <div class="modal-body"> <p id="modal-message"></p> </div>
            <div class="modal-footer">
                <button class="btn btn--secondary hidden" id="modal-cancel">Cancelar</button>
                <button class="btn" id="modal-confirm">OK</button>
            </div>
        </div>
    </div>
    
    <div class="modal hidden" id="image-modal">
        <div class="modal-content"><img id="modal-image" src="" alt="Documento Ampliado"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const app = {
                state: {
                    chatId: new URLSearchParams(window.location.search).get('chatId'),
                    isEditing: false,
                    currentClient: {},
                    allCars: [],
                    selectedInterestVehicles: [],
                    kanbanColumns: [],
                    newDocumentFiles: [],
                    newTradeInFiles: [],
                    removedDocuments: [],
                    removedTradeInPhotos: [],
                },
                API_BASE_URL: 'http://localhost:5000',
                DEAL_TYPE_MAP: { 'a_vista': 'À Vista', 'financiamento': 'Financiamento', 'troca': 'Troca', 'comum': 'Venda', 'visita': 'Visita' },

                async init() {
                    if (!this.state.chatId) {
                        document.body.innerHTML = `<h1>Erro: ID do cliente não fornecido na URL.</h1><a href="index.html" class="btn">Voltar</a>`;
                        return;
                    }
                    this.cacheElements();
                    this.addEventListeners();
                    await this.loadInitialData();
                },
                
                async loadInitialData() {
                    try {
                        await Promise.all([this.fetchKanbanStates(), this.fetchAllStockCars()]);
                        await this.fetchClientDetails();
                    } catch (error) {
                        this.showModal('Erro Crítico', `Não foi possível carregar os dados iniciais: ${error.message}`);
                    }
                },

                async fetchClientDetails() {
                    try {
                        const response = await fetch(`${this.API_BASE_URL}/api/clients/${this.state.chatId}`);
                        if (!response.ok) throw new Error('Cliente não encontrado.');
                        this.state.currentClient = await response.json();
                        this.renderAll();
                    } catch(error) {
                        this.showModal('Erro', error.message);
                    }
                },

                async fetchAllStockCars() {
                    const response = await fetch(`${this.API_BASE_URL}/api/cars`);
                    if (!response.ok) throw new Error('Falha ao carregar estoque de veículos.');
                    const data = await response.json();
                    this.state.allCars = data.modelos || [];
                },

                async fetchKanbanStates() {
                     this.state.kanbanColumns = [
                         { id: "leed_recebido", name: "Novo Lead" }, { id: "aguardando_interesse", name: "Aguardando Interesse" },
                         { id: "aguardando_escolha_carro", name: "Aguardando Escolha" }, { id: "aguardando_confirmacao_veiculo", name: "Aguardando Confirmação" },
                         { id: "aguardando_opcao_pagamento", name: "Aguardando Pagamento" }, { id: "dados_troca", name: "Dados de Troca" },
                         { id: "dados_financiamento", name: "Dados de Financiamento" }, { id: "finalizado", name: "Finalizado" },
                     ];
                     this.elements.profile.statusEdit.innerHTML = this.state.kanbanColumns.map(col => `<option value="${col.id}">${col.name}</option>`).join('');
                },

                renderAll() {
                    const client = this.state.currentClient;
                    if (!client.bot_data) client.bot_data = {};

                    this.elements.header.clientNameTitle.textContent = client.name || 'Detalhes do Cliente';
                    this.elements.profile.name.textContent = client.name || 'N/A';
                    this.elements.profile.phone.textContent = client.phone || 'N/A';
                    this.elements.profile.cpf.textContent = client.cpf || 'N/A';
                    this.elements.profile.job.textContent = client.job || 'N/A';
                    this.elements.profile.chatId.textContent = client.chat_id || 'N/A';

                    const state = client.bot_data.state || 'leed_recebido';
                    this.elements.profile.status.textContent = this.state.kanbanColumns.find(c => c.id === state)?.name || state;
                    
                    const dealType = client.deal_type || client.bot_data.deal_type;
                    this.elements.profile.dealType.textContent = this.DEAL_TYPE_MAP[dealType] || 'Não Definido';
                    
                    this.state.selectedInterestVehicles = this.state.allCars.filter(car =>
                        client.bot_data.interested_vehicles?.some(v => v.id === car.id)
                    );
                    
                    this.renderInterestVehicles();
                    this.renderFinancingDetails();
                    this.renderTradeInDetails();
                    this.updateVisibleCards();
                    this.renderHistory();
                    this.renderDocuments('documents');
                    this.renderDocuments('tradeInPhotos');
                    this.elements.notes.display.value = client.bot_data.notes || client.report || '';
                },

                renderInterestVehicles() {
                    const { pillsDisplay, pillsEdit } = this.elements.interest;
                    pillsDisplay.innerHTML = pillsEdit.innerHTML = '';
                    
                    if (this.state.selectedInterestVehicles.length === 0) {
                        pillsDisplay.innerHTML = '<span>Nenhum veículo de interesse</span>';
                    }

                    this.state.selectedInterestVehicles.forEach(vehicle => {
                        const pillHTML = `<span class="interest-pill" data-id="${vehicle.id}">${vehicle.nome}<button class="edit-field">&times;</button></span>`;
                        pillsDisplay.innerHTML += pillHTML.replace(/<button.*<\/button>/, '');
                        pillsEdit.innerHTML += pillHTML;
                    });
                    this.updateCalculations();
                },
                
                renderFinancingDetails() {
                    const fin = this.state.currentClient.bot_data.financing_details || {};
                    this.elements.financing.entry.textContent = this.toBRL(fin.entry);
                    this.elements.financing.installments.textContent = `${fin.parcels || 'N/A'}x`;
                },

                renderTradeInDetails() {
                    const trade = this.state.currentClient.bot_data.trade_in_car || {};
                    this.elements.tradeIn.model.textContent = trade.model || 'N/A';
                    this.elements.tradeIn.year.textContent = trade.year || 'N/A';
                    this.elements.tradeIn.value.textContent = this.toBRL(trade.value);
                    const payment = trade.difference_payment_method || {};
                    this.elements.tradeIn.paymentOption.textContent = this.DEAL_TYPE_MAP[payment.type] || 'N/A';
                    this.elements.tradeIn.installments.textContent = payment.type === 'financiamento' ? `${payment.parcels || 'N/A'}x` : '';
                },

                renderHistory() {
                    const history = this.state.currentClient.bot_data.history || [];
                    this.elements.history.list.innerHTML = history.length ? 
                        history.slice().reverse().map(item => {
                            const stateInfo = this.state.kanbanColumns.find(c => c.id === item.updated_data?.state)?.name;
                            const stateText = (stateInfo || (item.updated_data?.state || 'Interação')).replace(/_/g, ' ');
                            const timestamp = item.timestamp ? new Date(item.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3')).toLocaleString('pt-BR') : 'Data inválida';
                            return `<div class="history-item"><span class="state">${stateText}</span><span class="timestamp">${timestamp}</span></div>`;
                        }).join('') 
                        : '<p>Nenhum histórico.</p>';
                },
                
                renderDocuments(type) {
                    const isDoc = type === 'documents';
                    const elements = isDoc ? this.elements.documents : this.elements.tradeInPhotos;
                    const savedList = isDoc ? (this.state.currentClient.documents || []) : (this.state.currentClient.bot_data.trade_in_car?.photos || []);
                    const newList = isDoc ? this.state.newDocumentFiles : this.state.newTradeInFiles;

                    elements.gridDisplay.innerHTML = '';
                    elements.gridEdit.innerHTML = '';

                    if (savedList.length === 0 && newList.length === 0 && !this.state.isEditing) {
                        elements.gridDisplay.innerHTML = '<p>Nenhum arquivo.</p>';
                    }
                    
                    savedList.forEach(path => {
                        if (!path) return;
                        const url = new URL(path, this.API_BASE_URL).href;
                        const itemHTML = `
                            <div class="doc-wrapper" data-path="${path}">
                                <img src="${url}" alt="Documento" onerror="this.parentElement.style.display='none'">
                                <button class="doc-remove-btn edit-field" data-type="${type}">&times;</button>
                            </div>`;
                        elements.gridDisplay.innerHTML += itemHTML.replace(/<button.*<\/button>/, '');
                        elements.gridEdit.innerHTML += itemHTML;
                    });
                    
                    newList.forEach((file, index) => {
                        const url = URL.createObjectURL(file);
                        const itemHTML = `
                            <div class="doc-wrapper">
                                <img src="${url}" alt="${file.name}">
                                <button class="doc-remove-btn edit-field" data-new-index="${index}" data-type="${type}">&times;</button>
                            </div>`;
                        elements.gridEdit.innerHTML += itemHTML;
                    });
                },

                toggleEditMode(isEditing) {
                    this.state.isEditing = isEditing;
                    document.body.classList.toggle('editing', isEditing);
                    if (isEditing) {
                        this.populateEditFields();
                    } else {
                        this.state.newDocumentFiles = [];
                        this.state.newTradeInFiles = [];
                        this.state.removedDocuments = [];
                        this.state.removedTradeInPhotos = [];
                        this.fetchClientDetails(); // Recarrega os dados originais ao cancelar
                    }
                },

                populateEditFields() {
                    const client = this.state.currentClient;
                    const botData = client.bot_data || {};
                    
                    this.elements.profile.nameEdit.value = client.name || '';
                    this.elements.profile.phoneEdit.value = client.phone || '';
                    this.elements.profile.cpfEdit.value = client.cpf || '';
                    this.elements.profile.jobEdit.value = client.job || '';
                    this.elements.profile.statusEdit.value = botData.state || 'leed_recebido';
                    this.elements.profile.dealTypeEdit.value = botData.deal_type || client.deal_type || 'a_vista';
                    
                    const fin = botData.financing_details || {};
                    this.elements.financing.entryEdit.value = fin.entry ? this.toBRL(fin.entry).replace('R$ ', '') : '';
                    this.elements.financing.installmentsEdit.value = fin.parcels || '12';

                    const trade = botData.trade_in_car || {};
                    this.elements.tradeIn.modelEdit.value = trade.model || '';
                    this.elements.tradeIn.yearEdit.value = trade.year || '';
                    this.elements.tradeIn.valueEdit.value = trade.value ? this.toBRL(trade.value).replace('R$ ', '') : '';
                    
                    const payment = trade.difference_payment_method || {};
                    this.elements.tradeIn.paymentOptionEdit.value = payment.type || 'a_vista';
                    this.elements.tradeIn.installmentsEdit.value = payment.parcels || '12';

                    this.elements.notes.edit.value = botData.notes || client.report || '';
                    this.renderInterestVehicles();
                    this.renderDocuments('documents');
                    this.renderDocuments('tradeInPhotos');
                    this.updateVisibleCards();
                },
                
                updateVisibleCards() {
                    const dealType = this.state.isEditing ? this.elements.profile.dealTypeEdit.value : (this.state.currentClient.bot_data.deal_type || this.state.currentClient.deal_type);
                    const hasTradeIn = this.state.isEditing ? this.elements.tradeIn.modelEdit.value.trim() !== '' : !!this.state.currentClient.bot_data.trade_in_car?.model;
                    
                    this.elements.cards.financing.classList.toggle('hidden', dealType !== 'financiamento' && dealType !== 'troca');
                    this.elements.cards.tradeIn.classList.toggle('hidden', dealType !== 'troca' && !(dealType === 'financiamento' && hasTradeIn));
                    
                    this.updateCalculations();
                },


                updateCalculations() {
                    if (!this.state.isEditing) {
                        this.elements.financing.amountContainer.innerHTML = '';
                        this.elements.tradeIn.differenceSection.classList.add('hidden');
                        return;
                    }

                    const dealType = this.elements.profile.dealTypeEdit.value;
                    const entryValue = this.parseCurrency(this.elements.financing.entryEdit.value);
                    const tradeValue = this.parseCurrency(this.elements.tradeIn.valueEdit.value);

                    if (dealType === 'financiamento') {
                        const container = this.elements.financing.amountContainer;
                        container.innerHTML = '';
                        if (this.state.selectedInterestVehicles.length > 0) {
                            this.state.selectedInterestVehicles.forEach(car => {
                                const carPrice = this.parseCurrency(car.preco) || 0;
                                const amount = Math.max(0, carPrice - entryValue - tradeValue);
                                container.innerHTML += `<div class="info-group-highlight">Valor a financiar (${car.nome}): <strong>${this.toBRL(amount)}</strong></div>`;
                            });
                        } else {
                            container.innerHTML = `<div class="info-group-highlight">Selecione um veículo para calcular.</div>`;
                        }
                    }

                    if (dealType === 'troca') {
                        const { differenceSection, differenceValue } = this.elements.tradeIn;

                        if (this.state.selectedInterestVehicles.length > 0) {
                            const totalCarPrice = this.state.selectedInterestVehicles.reduce((sum, car) => sum + (this.parseCurrency(car.preco) || 0), 0);
                            const difference = totalCarPrice - tradeValue;
                            
                            if (difference > 0) {
                                differenceValue.innerHTML = `<div class="info-group-highlight">Diferença a pagar: <strong>${this.toBRL(difference)}</strong></div>`;
                                differenceSection.classList.remove('hidden');
                                this.toggleTradeInFinancing();
                            } else {
                                differenceValue.innerHTML = '<div class="info-group-highlight">O valor da troca cobre o valor dos veículos.</div>';
                                differenceSection.classList.remove('hidden');
                                this.elements.tradeIn.installmentsSection.parentElement.classList.add('hidden');
                            }
                        } else {
                            differenceSection.classList.add('hidden');
                        }
                    } else if (dealType !== 'financiamento') {
                        this.elements.financing.amountContainer.innerHTML = '';
                        this.elements.tradeIn.differenceSection.classList.add('hidden');
                    }
                },
                
                toggleTradeInFinancing() {
                    const isFinancing = this.elements.tradeIn.paymentOptionEdit.value === 'financiamento';
                    this.elements.tradeIn.installmentsSection.classList.toggle('hidden', !isFinancing);
                },
                
                async saveClientChanges() {
                    const payload = this.buildSavePayload();
                    try {
                        const textResponse = await fetch(`${this.API_BASE_URL}/api/clients/${this.state.chatId}`, {
                            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                        if (!textResponse.ok) throw new Error(`Falha ao salvar dados: ${await textResponse.text()}`);

                        const fileFormData = new FormData();
                        this.state.newDocumentFiles.forEach(file => fileFormData.append('documents', file));
                        this.state.newTradeInFiles.forEach(file => fileFormData.append('trade_in_photos', file));

                        if (fileFormData.has('documents') || fileFormData.has('trade_in_photos')) {
                            const fileResponse = await fetch(`${this.API_BASE_URL}/api/clients/${this.state.chatId}/files`, { method: 'POST', body: fileFormData });
                            if (!fileResponse.ok) throw new Error('Dados salvos, mas falha ao enviar novos arquivos.');
                        }
                        
                        if (this.state.removedDocuments.length > 0 || this.state.removedTradeInPhotos.length > 0) {
                            const removalPayload = { docPaths: [...this.state.removedDocuments, ...this.state.removedTradeInPhotos] };
                            const removalResponse = await fetch(`${this.API_BASE_URL}/api/clients/${this.state.chatId}/documents`, { 
                                method: 'DELETE', 
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(removalPayload)
                            });
                            if (!removalResponse.ok) console.warn("Falha ao remover alguns arquivos do servidor.");
                        }

                        this.showModal('Sucesso', 'Cliente atualizado com sucesso!');
                        this.toggleEditMode(false);
                        
                    } catch (error) {
                        this.showModal('Erro ao Salvar', error.message);
                    }
                },

                buildSavePayload() {
                    const client = this.state.currentClient;
                    const botData = JSON.parse(JSON.stringify(client.bot_data || {}));
                    
                    botData.state = this.elements.profile.statusEdit.value;
                    botData.notes = this.elements.notes.edit.value;
                    botData.interested_vehicles = this.state.selectedInterestVehicles.map(v => ({id: v.id, nome: v.nome, preco: v.preco}));
                    
                    const dealType = this.elements.profile.dealTypeEdit.value;
                    botData.deal_type = dealType;
                    
                    botData.financing_details = {
                        entry: this.parseCurrency(this.elements.financing.entryEdit.value),
                        parcels: this.elements.financing.installmentsEdit.value,
                    };
                    
                    if (!botData.trade_in_car) botData.trade_in_car = {};
                    botData.trade_in_car.model = this.elements.tradeIn.modelEdit.value;
                    botData.trade_in_car.year = this.elements.tradeIn.yearEdit.value;
                    botData.trade_in_car.value = this.parseCurrency(this.elements.tradeIn.valueEdit.value);
                    botData.trade_in_car.difference_payment_method = {
                        type: this.elements.tradeIn.paymentOptionEdit.value,
                        parcels: this.elements.tradeIn.installmentsEdit.value,
                    };
                    
                    return {
                        name: this.elements.profile.nameEdit.value,
                        phone: this.elements.profile.phoneEdit.value,
                        cpf: this.elements.profile.cpfEdit.value,
                        job: this.elements.profile.jobEdit.value,
                        report: botData.notes,
                        bot_data: botData,
                        deal_type: dealType
                    };
                },
                
                async deleteClient() {
                    const confirmed = await this.showModal('Confirmar Exclusão', 'Tem certeza que deseja EXCLUIR este cliente? Esta ação é irreversível.', true);
                    if (confirmed) {
                        try {
                            const response = await fetch(`${this.API_BASE_URL}/api/clients/${this.state.chatId}`, { method: 'DELETE' });
                            if (!response.ok) throw new Error('Falha ao excluir o cliente.');
                            await this.showModal('Sucesso', 'Cliente excluído. Redirecionando...');
                            setTimeout(() => { window.location.href = 'index.html'; }, 1500);
                        } catch (error) {
                            this.showModal('Erro', error.message);
                        }
                    }
                },

                addEventListeners() {
                    this.elements.actions.edit.addEventListener('click', () => this.toggleEditMode(true));
                    this.elements.actions.save.addEventListener('click', () => this.saveClientChanges());
                    this.elements.actions.cancel.addEventListener('click', () => this.toggleEditMode(false));
                    this.elements.actions.delete.addEventListener('click', () => this.deleteClient());
                    
                    this.elements.interest.search.addEventListener('keyup', (e) => this.handleVehicleSearch(e.target.value));
                    this.elements.interest.search.addEventListener('blur', () => setTimeout(() => this.elements.interest.results.classList.add('hidden'), 200));
                    this.elements.interest.pillsEdit.addEventListener('click', (e) => this.handlePillRemoval(e));

                    [this.elements.financing.entryEdit, this.elements.tradeIn.valueEdit].forEach(input => {
                        input.addEventListener('input', (e) => {
                            this.formatCurrencyInput(e.target); this.updateCalculations();
                        });
                    });
                    
                    this.elements.tradeIn.yearEdit.addEventListener('input', (e) => e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4));

                    this.elements.profile.dealTypeEdit.addEventListener('change', () => this.updateVisibleCards());
                    this.elements.tradeIn.paymentOptionEdit.addEventListener('change', () => this.toggleTradeInFinancing());

                    this.elements.documents.input.addEventListener('change', (e) => this.handleFileSelect(e, 'documents'));
                    this.elements.tradeInPhotos.input.addEventListener('change', (e) => this.handleFileSelect(e, 'tradeInPhotos'));
                    
                    this.elements.documents.gridEdit.addEventListener('click', (e) => this.handleFileRemoval(e));
                    this.elements.tradeInPhotos.gridEdit.addEventListener('click', (e) => this.handleFileRemoval(e));
                    
                    this.elements.modals.image.addEventListener('click', () => this.elements.modals.image.classList.add('hidden'));
                    document.body.addEventListener('click', e => {
                        if (e.target.closest('.doc-wrapper img')) this.showImageModal(e.target.src);
                    });
                },
                
                handleVehicleSearch(query) {
                    const { results } = this.elements.interest;
                    query = query.toLowerCase();
                    if (!query) { results.classList.add('hidden'); return; }
                    
                    const filtered = this.state.allCars.filter(car => 
                        car.nome.toLowerCase().includes(query) && !this.state.selectedInterestVehicles.some(v => v.id === car.id)
                    );

                    results.innerHTML = '';
                    if (filtered.length) {
                        filtered.forEach(car => {
                            const item = document.createElement('div');
                            item.textContent = `${car.nome} - ${this.toBRL(this.parseCurrency(car.preco))}`;
                            item.addEventListener('click', () => {
                                this.state.selectedInterestVehicles.push(car);
                                this.renderInterestVehicles();
                                results.classList.add('hidden');
                                this.elements.interest.search.value = '';
                            });
                            results.appendChild(item);
                        });
                        results.classList.remove('hidden');
                    } else {
                        results.classList.add('hidden');
                    }
                },

                handlePillRemoval(e) {
                    if (e.target.tagName !== 'BUTTON') return;
                    const vehicleId = e.target.parentElement.dataset.id;
                    this.state.selectedInterestVehicles = this.state.selectedInterestVehicles.filter(v => v.id !== vehicleId);
                    this.renderInterestVehicles();
                },

                handleFileSelect(event, type) {
                    const files = Array.from(event.target.files);
                    const fileArray = type === 'documents' ? this.state.newDocumentFiles : this.state.newTradeInFiles;
                    fileArray.push(...files);
                    this.renderDocuments(type);
                },

                handleFileRemoval(event) {
                    if (!event.target.classList.contains('doc-remove-btn')) return;
                    const { newIndex, type } = event.target.dataset;
                    const wrapper = event.target.closest('.doc-wrapper');
                    const existingPath = wrapper.dataset.path;
                    
                    const isDoc = type === 'documents';
                    const newFileArray = isDoc ? this.state.newDocumentFiles : this.state.newTradeInFiles;
                    const removalArray = isDoc ? this.state.removedDocuments : this.state.removedTradeInPhotos;
                    
                    if (newIndex !== undefined) {
                        newFileArray.splice(parseInt(newIndex, 10), 1);
                        this.renderDocuments(type);
                    } else if (existingPath) {
                        if (!removalArray.includes(existingPath)) removalArray.push(existingPath);
                        wrapper.style.display = 'none';
                    }
                },
                
                cacheElements() {
                    this.elements = {
                        header: { 
                            clientNameTitle: document.getElementById('client-name-title'),
                            actions: document.querySelector('.header-actions')
                        },
                        profile: { name: document.getElementById('client-name-detail'), nameEdit: document.getElementById('client-name-edit'), phone: document.getElementById('client-phone-detail'), phoneEdit: document.getElementById('client-phone-edit'), cpf: document.getElementById('client-cpf-detail'), cpfEdit: document.getElementById('client-cpf-edit'), job: document.getElementById('client-job-detail'), jobEdit: document.getElementById('client-job-edit'), status: document.getElementById('client-status-detail'), statusEdit: document.getElementById('client-status-edit'), dealType: document.getElementById('client-deal-type-detail'), dealTypeEdit: document.getElementById('client-deal-type-edit'), chatId: document.getElementById('client-chat-id-detail') },
                        interest: { search: document.getElementById('interest-search'), results: document.getElementById('interest-results'), pillsDisplay: document.getElementById('interest-pills-display'), pillsEdit: document.getElementById('interest-pills-edit') },
                        financing: { entry: document.getElementById('financing-entry-detail'), entryEdit: document.getElementById('financing-entry-edit'), installments: document.getElementById('financing-installments-detail'), installmentsEdit: document.getElementById('financing-installments-edit'), amountContainer: document.getElementById('financing-amount-container') },
                        tradeIn: { model: document.getElementById('trade-in-model-detail'), modelEdit: document.getElementById('trade-in-model-edit'), year: document.getElementById('trade-in-year-detail'), yearEdit: document.getElementById('trade-in-year-edit'), value: document.getElementById('trade-in-value-detail'), valueEdit: document.getElementById('trade-in-value-edit'), differenceSection: document.getElementById('trade-in-difference-section'), differenceValue: document.getElementById('trade-in-difference-value'), paymentOption: document.getElementById('trade-in-payment-option-detail'), paymentOptionEdit: document.getElementById('trade-in-payment-option-edit'), installmentsSection: document.getElementById('trade-in-installments-section'), installments: document.getElementById('trade-in-installments-detail'), installmentsEdit: document.getElementById('trade-in-installments-edit') },
                        history: { list: document.getElementById('client-history') },
                        documents: { gridDisplay: document.getElementById('documents-grid-display'), gridEdit: document.getElementById('documents-grid-edit'), input: document.getElementById('add-docs-input') },
                        tradeInPhotos: { gridDisplay: document.getElementById('trade-in-photos-grid-display'), gridEdit: document.getElementById('trade-in-photos-grid-edit'), input: document.getElementById('add-trade-in-photos-input') },
                        notes: { display: document.getElementById('crm-notes-display'), edit: document.getElementById('crm-notes-edit') },
                        actions: { 
                            edit: document.querySelector('.edit-btn'), 
                            save: document.querySelector('.save-btn'), 
                            cancel: document.querySelector('.cancel-btn'), 
                            delete: document.querySelector('.delete-btn'),
                            back: document.querySelector('.back-btn')
                        },
                        cards: { financing: document.getElementById('financing-card'), tradeIn: document.getElementById('trade-in-card') },
                        modals: { image: document.getElementById('image-modal'), imageTag: document.getElementById('modal-image'), custom: document.getElementById('custom-modal'), title: document.getElementById('modal-title'), message: document.getElementById('modal-message'), confirm: document.getElementById('modal-confirm'), cancel: document.getElementById('modal-cancel') }
                    };
                },
                
                showModal(title, message, isConfirm = false) {
                    return new Promise(resolve => {
                        this.elements.modals.title.textContent = title;
                        this.elements.modals.message.textContent = message;
                        this.elements.modals.cancel.classList.toggle('hidden', !isConfirm);
                        this.elements.modals.custom.classList.remove('hidden');

                        const confirmHandler = () => { cleanup(); resolve(true); };
                        const cancelHandler = () => { cleanup(); resolve(false); };
                        const cleanup = () => {
                            this.elements.modals.confirm.removeEventListener('click', confirmHandler);
                            this.elements.modals.cancel.removeEventListener('click', cancelHandler);
                            this.elements.modals.custom.classList.add('hidden');
                        };
                        this.elements.modals.confirm.addEventListener('click', confirmHandler, { once: true });
                        this.elements.modals.cancel.addEventListener('click', cancelHandler, { once: true });
                    });
                },

                showImageModal(src) {
                    this.elements.modals.imageTag.src = src;
                    this.elements.modals.image.classList.remove('hidden');
                },
                
                toBRL(value) {
                    if (value === null || value === undefined || value === '') return 'R$ 0,00';
                    const num = typeof value === 'number' ? value : this.parseCurrency(value);
                    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                },

                parseCurrency(value) {
                    if (typeof value === 'number') return value;
                    if (!value || typeof value !== 'string') return 0;
                    return parseFloat(value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                },

                formatCurrencyInput(input) {
                    let value = input.value.replace(/\D/g, '');
                    if (value === '') { input.value = ''; return; }
                    const numValue = parseInt(value, 10) / 100;
                    input.value = numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            };
            
            app.init();
        });
    </script>
</body>
</html>